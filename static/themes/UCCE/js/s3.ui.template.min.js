import{Map,View,Draw,Fill,GeoJSON,getCenter,ImageLayer,Projection,Static,Stroke,Style,VectorLayer,VectorSource}from"./ol.dc_editor.min.js";!function(factory){"use strict";!function($,loadImage,Map,View,Draw,Fill,GeoJSON,getCenter,ImageLayer,Projection,Static,Stroke,Style,VectorLayer,VectorSource){var format,surveyID=0,draws={},maps={},sources={},imageFiles={},imageOptions=[],likertOptions={1:["Very appropriate","Somewhat appropriate","Neither appropriate nor inappropriate","Somewhat inappropriate","Very inappropriate"],2:["Extremely confident","Very confident","Moderately confident","Slightly confident","Not confident at all"],3:["Always","Often","Occasionally","Rarely","Never"],4:["Extremely safe","Very safe","Moderately safe","Slightly safe","Not safe at all"],5:["Very satisfied","Somewhat satisfied","Neither satisfied nor dissatisfied","Somewhat dissatisfied","Very dissatisfied"],6:[],7:[]},pages={},pageElements={},questionNumbers={},typesToInt={text:1,number:2,multichoice:6,likert:12,heatmap:13},typesToText={1:"text",2:"number",6:"multichoice",12:"likert",13:"heatmap"},truncate=function(str){return str.length>53?str.substring(0,50)+"...":str};$.widget("s3.surveyLayout",{options:{readOnly:!1},_create:function(){this.id=surveyID,surveyID+=1,this.eventNamespace=".surveyEditor"},_init:function(options){var el=$(this.element),fieldname=el.attr("id");fieldname||(fieldname="surveyEditor-widget-"+this.id),this.fieldname=fieldname,this.recordID=el.data("id"),this.data=null,void 0!==$.searchS3?this.ajaxMethod=$.searchS3:this.ajaxMethod=$.ajaxS3,$.validator.addMethod("lessThanMax",(function(value,element){var questionID=element.id.split("-")[1],max=$("#max-"+questionID).val();return""==max?this.optional(element)||!0:this.optional(element)||parseFloat(value)<=max}),"needs to be lower than Maximum"),$.validator.addMethod("greaterThanMin",(function(value,element){var questionID=element.id.split("-")[1],min=$("#min-"+questionID).val();return""==min?this.optional(element)||!0:this.optional(element)||parseFloat(value)>=min}),"needs to be higher than Minimum"),this.refresh()},addQuestion:function(position,page,type,questionID){if("instructions"==type)questionID?this._addQuestion(position,page,type,null,!0):this._addQuestion(position,page,type);else if(questionID)this._addQuestion(position,page,type,questionID,!0);else{var self=this,ajaxURL=S3.Ap.concat("/dc/question/create_json.json"),data=JSON.stringify({type:typesToInt[type],template_id:this.recordID});this.ajaxMethod({url:ajaxURL,type:"POST",data:data,dataType:"json",success:function(data){self._addQuestion(position,page,type,data.question_id)},error:function(jqXHR,textStatus,errorThrown){var msg;msg="UNAUTHORIZED"==errorThrown?i18n.gis_requires_login:jqXHR.responseText,console.log(msg)}})}},_addQuestion:function(position,page,type,questionID,load){var item,questionNumber,l10n=this.data.l10n,layout=this.data.layout,questions=this.data.questions,readOnly=this.options.readOnly;if(load){for(var i=1,len=Object.keys(questionNumbers).length;i<=len;i++)if(position==questionNumbers[i]){questionNumber=i;break}}else if("instructions"!=type){var questionNumbersLength=Object.keys(questionNumbers).length;if(questionNumbersLength)if(position>Object.keys(layout).length)questionNumber=questionNumbersLength+1;else{for(var thisItem,p=position-1;p>0;p--)if("question"==(thisItem=layout[p]).type){var previousQuestionID=thisItem.id;questionNumber=$("#question-"+previousQuestionID).data("number")+1;break}questionNumber||(questionNumber=1)}else questionNumber=1;questions[questionID]={type:typesToInt[type],settings:{},options:[]}}var idHtml,dataHtml,editTab,formElements,imageHtml,itemSelector,newChoice,newChoiceL10n,optionsHtml,logicTab,mandatory,moveUp,moveDown,question,thisQuestion,translationTab,trash,translationHidden="";l10n||(translationHidden=" hide");var translationTitle='<li class="tabs-title l10n'+translationHidden+'"><a href="#translation-'+position+'">Translation</a></li>';if("instructions"==type)idHtml="instructions-"+position,dataHtml="",formElements="#instructions-"+position+" textarea, #instructions-"+position+" select",itemSelector="#instructions-"+position,trash="#instructions-"+position+" .ucce-delete",moveUp="#instructions-"+position+" .ucce-up",moveDown="#instructions-"+position+" .ucce-down";else{idHtml="question-"+questionID,dataHtml=' data-number="'+questionNumber+'"',formElements="#question-"+questionID+" input, #question-"+questionID+" select",itemSelector="#question-"+questionID,trash="#question-"+questionID+" .ucce-delete",moveUp="#question-"+questionID+" .ucce-up",moveDown="#question-"+questionID+" .ucce-down";var checked="";settings=(thisQuestion=questions[questionID]).settings||{},load&&settings.requires&&settings.requires.isNotEmpty&&(checked=" checked"),mandatory='<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="mandatory-'+questionID+'" type="checkbox" '+checked+' class="fleft"><label>Make question mandatory</label></div></div>',"heatmap"!=type&&(optionsHtml=this.pipeOptionsHtml(questionID),imageHtml='<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Add image</label><span id="preview-'+questionID+'" class="preview-empty fleft"></span><label for="image-'+questionID+'" class="button tiny fleft">Upload image</label><input id="image-'+questionID+'" name="file" type="file" accept="image/png, image/jpeg" class="show-for-sr"><label class="fleft">or pipe question image:</label><select id="pipe-'+questionID+'" class="fleft">'+optionsHtml+'</select><a id="image-delete-'+questionID+'">Delete</a></div></div>')}switch(question='<div class="thumbnail dl-item survey-item" id="'+idHtml+'" data-page="'+page+'"'+dataHtml+'><div class="card-header"><ul class="tabs fleft" data-tabs id="tabs-'+position+'"><li class="tabs-title is-active"><a href="#edit-'+position+'">Edit</a></li><li class="tabs-title"><a href="#logic-'+position+'">Display logic</a></li> '+translationTitle+'</ul><div class="edit-bar fright"><a><i class="ucce ucce-delete"> </i></a><div class="fright"><div class="move-up"><i class="ucce ucce-up"> </i></div><div class="move-down"><i class="ucce ucce-down"> </i></div></div></div></div><div class="tabs-content" data-tabs-content="tabs-'+position+'">',logicTab='<div class="media tabs-panel" id="logic-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Only display question if...</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><select id="logic-select-'+position+'"></select></div></div><div class="row" id="logic-response-row-'+position+'"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-2"><label class="fleft">response is</label></div><div class="columns medium-10" id="logic-response-'+position+'"></div></div></div></div></div>',type){case"instructions":var doText="",doTextL10n="",sayText="",sayTextL10n="";if(load){var thisLayout=layout[position];doText=thisLayout.do.text,sayText=thisLayout.say.text,l10n&&thisLayout.do.l10n&&(doTextL10n=thisLayout.do.l10n[l10n],sayTextL10n=thisLayout.say.l10n[l10n])}editTab='<div class="media tabs-panel is-active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Data collector instructions</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>What data collector should do</label><textarea id="do-'+position+'" type="text" size=100 placeholder="Type what data collector should do">'+doText+'</textarea><label>What data collector should say</label><textarea id="say-'+position+'" type="text" size=100 placeholder="Type what data collector should say">'+sayText+"</textarea></div></div></div>",translationTab='<div class="media tabs-panel" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Data collector instructions</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>What data collector should do</label><div class="translate-from"></div><textarea id="do-l10n-'+position+'" type="text" size=100 placeholder="Type translation...">'+doTextL10n+'</textarea><label>What data collector should say</label><div class="translate-from"></div><textarea id="say-l10n-'+position+'" type="text" size=100 placeholder="Type translation...">'+sayTextL10n+"</textarea></div></div></div>";break;case"text":var name="",nameL10n="";load&&(name=thisQuestion.name,l10n&&(nameL10n=thisQuestion.name_l10n||"")),editTab='<div class="media tabs-panel is-active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Text box</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><input id="name-'+questionID+'" type="text" size=100 placeholder="type question" value="'+name+'"></div></div>'+mandatory+imageHtml+"</div>",translationTab='<div class="media tabs-panel" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Text box</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+questionID+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+questionID+'" type="text" size=100 placeholder="type translated question" value="'+nameL10n+'"></div></div></div>';break;case"number":name="",nameL10n="";var min="",max="";if(load){name=thisQuestion.name,l10n&&(nameL10n=thisQuestion.name_l10n||"");var isIntInRange=(settings.requires||{}).isIntInRange;isIntInRange&&(min=isIntInRange.min||"",max=isIntInRange.max||"")}editTab='<div class="media tabs-panel is-active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Number question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><input id="name-'+questionID+'"type="text" size=100 placeholder="type question" value="'+name+'"></div></div>'+mandatory+imageHtml+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Restrict input to:</label></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><form id="answer-'+questionID+'"><label class="fleft">Minimum:</label><input id="min-'+questionID+'" name="min" type="number" value="'+min+'" class="fleft"><label class="fleft">Maximum:</label><input id="max-'+questionID+'" name="max" type="number" value="'+max+'" class="fleft"></form></div></div></div>',translationTab='<div class="media tabs-panel" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Number question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+questionID+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+questionID+'" type="text" size=100 placeholder="type translated question" value="'+nameL10n+'"></div></div></div>';break;case"multichoice":newChoice='<div id="choice-row-'+questionID+'-0" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input class="choice-'+questionID+'" type="text" placeholder="Enter an answer choice"><i class="ucce ucce-minus"> </i><i class="ucce ucce-plus"> </i></div></div>',newChoiceL10n='<div id="choice-l10n-row-'+questionID+'-0" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+questionID+'-0" class="translate-from"></div></div><div class="columns medium-6"><input class="choice-l10n-'+questionID+'" type="text" placeholder="Type translation..."></div></div></div></div>';name="",nameL10n="";var other="",otherDisabled=" disabled",otherLabel="Other (please specify)",otherL10n="",multiple=1,multiChecked="";if(load){name=thisQuestion.name,l10n&&(nameL10n=thisQuestion.name_l10n||"");var otherL10nHide,options=thisQuestion.options||[],optionsL10n=thisQuestion.options_l10n||[];if(lenOptions=options.length){var thisOptionL10n;choices="",choicesL10n="";for(i=0;i<lenOptions;i++)choices+='<div id="choice-row-'+questionID+"-"+i+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input class="choice-'+questionID+'" type="text" placeholder="Enter an answer choice" value="'+options[i]+'"><i class="ucce ucce-minus"> </i><i class="ucce ucce-plus"> </i></div></div>',thisOptionL10n=optionsL10n[i]||"",choicesL10n+='<div id="choice-l10n-row-'+questionID+"-"+i+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+questionID+"-"+i+'" class="translate-from">'+options[i]+'</div></div><div class="columns medium-6"><input class="choice-l10n-'+questionID+'" type="text" placeholder="Type translation..." value="'+thisOptionL10n+'"></div></div></div></div>'}else choices=newChoice,choicesL10n=newChoiceL10n;settings.other?(otherLabel=settings.other,other=" checked",otherDisabled="",otherL10n=settings.otherL10n||"",otherL10nHide=""):otherL10nHide=" hide",choicesL10n+='<div id="other-l10n-row-'+questionID+'" class="row'+otherL10nHide+'"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="other-l10n-from-'+questionID+'" class="translate-from">'+otherLabel+'</div></div><div class="columns medium-6"><input id="other-l10n-'+questionID+'" type="text" placeholder="Type translation..." value="'+otherL10n+'"></div></div></div></div>',(multiple=settings.multiple||1)>1&&(multiChecked=" checked")}else choices=newChoice,choicesL10n=newChoiceL10n+('<div id="other-l10n-row-'+questionID+'" class="row hide"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="other-l10n-from-'+questionID+'" class="translate-from"></div></div><div class="columns medium-6"><input id="other-l10n-'+questionID+'" type="text" placeholder="Type translation..."></div></div></div></div>');editTab='<div class="media tabs-panel is-active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Multiple choice question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><input id="name-'+questionID+'"type="text" size=100 placeholder="type question" value="'+name+'"></div></div>'+mandatory+imageHtml+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Choices</label></div></div>'+choices+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="other-'+questionID+'" type="checkbox"'+other+'><label>Add \'other field\'</label></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label class="fleft">Field label</label><input id="other-label-'+questionID+'" type="text" value="'+otherLabel+'"'+otherDisabled+'></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="multiple-'+questionID+'" type="checkbox"'+multiChecked+'><label>Allow multiple responses</label></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label class="fleft">Maximum No. of responses:</label><i class="ucce ucce-minus"> </i> <span id="multiple-count-'+questionID+'">'+multiple+'</span> <i class="ucce ucce-plus"> </i></div></div></div>',translationTab='<div class="media tabs-panel" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Multiple choice question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+questionID+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+questionID+'" type="text" size=100 placeholder="type translated question" value="'+nameL10n+'"></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row" id="choices-l10n-row-'+questionID+'"><div class="columns medium-1"></div><div class="columns medium-11"><label>Choices</label></div></div>'+choicesL10n+"</div>";break;case"likert":name="",nameL10n="";var settings,choicesL10n="",displayOptions="",scales=['<option value="1">Appropriateness (Very appropriate - Very inappropriate)</option>','<option value="2">Confidence (Extremely confident - Not confident at all)</option>','<option value="3">Frequency (Always - Never)</option>','<option value="4">Safety (Extremely safe - Not safe at all)</option>','<option value="5">Satisfaction (Satisfied - Dissatisfied)</option>','<option value="6">Smiley scale (5 point)</option>','<option value="7">Smiley scale (3 point)</option>'];if(load)if(name=thisQuestion.name,l10n&&(nameL10n=thisQuestion.name_l10n||""),(settings=thisQuestion.settings)&&settings.hasOwnProperty("scale")){var scale=settings.scale;if(scale){scales[scale-1]=scales[scale-1].replace('">','" selected>');var result=this.likertOptionsHtml(questionID,scale);choicesL10n=result.choicesL10n,displayOptions=result.displayOptions}}var scaleOptions=scales.join();editTab='<div class="media tabs-panel is-active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Likert-scale</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><input id="name-'+questionID+'"type="text" size=100 placeholder="type question" value="'+name+'"></div></div>'+mandatory+imageHtml+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Answer</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Choices</label><select id="scale-'+questionID+'"><option value="">Please choose scale</option>'+scaleOptions+'</select></div></div><div class="row"><div class="columns medium-1"></div><div id="display-'+questionID+'" class="columns medium-11">'+displayOptions+"</div></div></div>",translationTab='<div class="media tabs-panel" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Likert-scale</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+questionID+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+questionID+'" type="text" size=100 placeholder="type translated question" value="'+nameL10n+'"></div></div>'+choicesL10n+"</div>";break;case"heatmap":name="",nameL10n="";var numClicks=1,choices=newChoice='<div id="choice-row-'+questionID+'-0" class="row"><a class="button tiny secondary choice-define-'+questionID+'">Add region 1</a><input type="hidden" id="choice-json-'+questionID+'-0"><input class="choice-'+questionID+'" type="text" placeholder="enter label" disabled><i class="ucce ucce-minus hide"> </i></div>';choicesL10n="",optionsL10n="";if(load){name=thisQuestion.name,l10n&&(nameL10n=thisQuestion.name_l10n||"");var lenOptions;options=thisQuestion.options||[],optionsL10n=thisQuestion.options_l10n||[];if(lenOptions=options.length){choices="";var regions=thisQuestion.settings.regions;for(i=0;i<lenOptions;i++)choices+='<div id="choice-row-'+questionID+"-"+i+'" class="row"><a class="button tiny choice-define-'+questionID+'">Add region '+(i+1)+'</a><input type="hidden" id="choice-json-'+questionID+"-"+i+"\" value='"+regions[i]+"'><input class=\"choice-"+questionID+'" type="text" placeholder="enter label" value="'+options[i]+'"><i class="ucce ucce-minus"> </i></div>',thisOptionL10n=optionsL10n[i]||"",choicesL10n+='<div id="choice-l10n-row-'+questionID+"-"+i+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+questionID+"-"+i+'" class="translate-from">'+options[i]+'</div></div><div class="columns medium-6"><input class="choice-l10n-'+questionID+'" type="text" placeholder="Type translation..." value="'+thisOptionL10n+'"></div></div></div></div>';choices+=newChoice.replace(/-0/gi,"-"+lenOptions).replace("region 1","region "+(lenOptions+1))}numClicks=thisQuestion.settings.numClicks||1}editTab='<div class="media tabs-panel is-active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Heatmap</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><input id="name-'+questionID+'"type="text" size=100 placeholder="type question" value="'+name+'"></div></div>'+mandatory+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Image</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label for="image-'+questionID+'" class="button tiny fleft">Upload image</label><input id="image-'+questionID+'" name="file" type="file" accept="image/png, image/jpeg" class="show-for-sr"></div></div><div class="row"><div class="columns medium-8"><div class="heatmap" id="map-'+questionID+'"><span id="preview-'+questionID+'" class="preview-empty fleft"></span></div></div><div class="columns medium-4"><div class="row"><h3>Number of clicks allowed:</h3></div><div class="row" id="clicks-row-'+questionID+'"><i class="ucce ucce-minus"> </i><span> '+numClicks+' </span><i class="ucce ucce-plus"> </i></div><div class="row"><h3>Tap regions:</h3></div>'+choices+"</div></div></div>",translationTab='<div class="media tabs-panel" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Heatmap</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+questionID+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+questionID+'" type="text" size=100 placeholder="type translated question" value="'+nameL10n+'"></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row" id="choices-l10n-row-'+questionID+'"><div class="columns medium-1"></div><div class="columns medium-11"><label>Regions</label></div></div>'+choicesL10n+"</div>"}if(question+=editTab,question+=logicTab,question+=translationTab,question+="</div></div>",item="instructions"==type?{type:"instructions",do:{text:""},say:{text:""}}:{type:"question",id:questionID},load||this.rePosition(item,null,position),readOnly)$(this.element).parent().append(question);else if(load||position==Object.keys(layout).length)$("#survey-droppable").before(question);else{var previousPosition=position-1,previousItem=layout[previousPosition];"break"==previousItem.type?$("#section-break-"+previousPosition).parent().after(question):"instructions"==previousItem.type?$("#instructions-"+previousPosition).after(question):$("#question-"+previousItem.id).after(question)}var ns=this.eventNamespace,self=this,$item=$(itemSelector);readOnly||$(itemSelector).droppable({drop:function(event,ui){var currentPosition,questionType=ui.draggable[0].id,currentPage=$(this).data("page");if("instructions"==type)currentPosition=parseInt(this.id.split("-")[1]);else{var currentQuestionNumber=$(this).data("number");currentPosition=questionNumbers[currentQuestionNumber]}"break"==questionType?self.addSectionBreak(currentPosition+1,currentPage):self.addQuestion(currentPosition+1,currentPage,questionType)}});var inputEvents=function(){$(formElements).off("change"+ns).on("change"+ns,(function(){var parts=this.id.split("-"),part_0=parts[0];if("logic"==part_0){var currentPosition=parseInt(parts[parts.length-1]);self.logicSelected($(this),currentPosition)}else{var l10n=self.data.l10n;if("instructions"==type){currentPosition=parseInt(parts[parts.length-1]);var thisLayout=layout[currentPosition];l10n&&(thisLayout.do.hasOwnProperty("l10n")||(thisLayout.do.l10n={}),thisLayout.say.hasOwnProperty("l10n")||(thisLayout.say.l10n={})),"do"==part_0?"l10n"==parts[1]?thisLayout.do.l10n[l10n]=$("#do-l10n-"+currentPosition).val():(thisLayout.do.text=$("#do-"+currentPosition).val(),l10n&&($("#do-l10n-"+currentPosition).val(""),thisLayout.do.l10n[l10n]="")):"l10n"==parts[1]?thisLayout.say.l10n[l10n]=$("#say-l10n-"+currentPosition).val():(thisLayout.say.text=$("#say-"+currentPosition).val(),l10n&&($("#say-l10n-"+currentPosition).val(""),thisLayout.say.l10n[l10n]="")),self.saveLayout()}else{if(l10n)if("name"==part_0&&"l10n"!=parts[1])$("#name-l10n-"+questionID).val("");else if(""==part_0){var choiceRowID=$(this).parent().attr("id");void 0!==choiceRowID?"choice"==(parts=choiceRowID.split("-"))[0]&&$("#choice-from-"+questionID+"-"+parts[3]).parent().next().children().first().val(""):void 0!==(choiceRowID=$(this).parent().parent().attr("id"))&&"choice"==(parts=choiceRowID.split("-"))[0]&&$("#choice-from-"+questionID+"-"+parts[3]).parent().next().children().first().val("")}self.saveQuestion(type,questionID)}}})),readOnly||"instructions"==type||"heatmap"==type||$("#pipe-"+questionID).on("change"+ns,(function(){var value=$(this).val();if(value){for(var img,imageQuestionID,i=0,len=imageOptions.length;i<len;i++)if((img=imageOptions[i]).label==value){imageQuestionID=img.id,thisQuestion.settings.pipeImage={id:imageQuestionID,region:img.region};break}self.deleteImage(questionID),loadImage(S3.Ap.concat("/default/download/"+imageFiles[imageQuestionID]),(function(img){var options={canvas:!0,maxHeight:80,maxWidth:80},preview=loadImage.scale(img,options);return $("#preview-"+questionID).removeClass("preview-empty").empty().append(preview),img}),{})}else delete thisQuestion.settings.pipeImage,$("#preview-"+questionID).addClass("preview-empty").empty();self.saveQuestion(type,questionID)}))};if(inputEvents(),"instructions"!=type){if(load){var file=thisQuestion.file;file?(imageFiles[questionID]=file,"heatmap"==type?self.heatMap(questionID,file,load):loadImage(S3.Ap.concat("/default/download/"+file),(function(img){var options={canvas:!0,maxHeight:80,maxWidth:80},preview=loadImage.scale(img,options);return $("#preview-"+questionID).removeClass("preview-empty").empty().append(preview),img}),{})):thisQuestion.settings.pipeImage&&$("#pipe-"+questionID).trigger("change")}if(!readOnly)$("#image-delete-"+questionID).on("click"+ns,(function(){self.deleteImage(questionID)})),options="heatmap"==type?{dataType:"json",dropZone:$("#preview-"+questionID+", #image-"+questionID),disableImageResize:!1,imageMaxWidth:480,imageMaxHeight:480,imageMinWidth:480,imageMinheight:480,maxNumberOfFiles:1,url:S3.Ap.concat("/dc/question/")+questionID+"/image_upload.json",add:function(e,data){if(e.isDefaultPrevented())return!1;(data.autoUpload||!1!==data.autoUpload&&$(this).fileupload("option","autoUpload"))&&data.process().done((function(){data.submit()}))},done:function(e,data){var file=data.result.file;imageFiles[questionID]=file,thisQuestion.file=file,self.heatMap(questionID,file)}}:{dataType:"json",disableImageResize:!1,dropZone:$("#preview-"+questionID+", #image-"+questionID),maxNumberOfFiles:1,url:S3.Ap.concat("/dc/question/")+questionID+"/image_upload.json",add:function(e,data){if(e.isDefaultPrevented())return!1;(data.autoUpload||!1!==data.autoUpload&&$(this).fileupload("option","autoUpload"))&&data.process().done((function(){data.submit();var file=data.files[0];loadImage(file,(function(img){var options={canvas:!0,maxHeight:80,maxWidth:80},preview=loadImage.scale(img,options);return $("#preview-"+questionID).removeClass("preview-empty").empty().append(preview),thisQuestion.settings.hasOwnProperty("pipeImage")&&$("#pipe-"+questionID).val("").trigger("change"),img}),{})}))},done:function(e,data){var file=data.result.file;imageFiles[questionID]=file,thisQuestion.file=file,self.updateImageOptions()}},$("#image-"+questionID).fileupload(options)}switch(readOnly||($(trash).on("click"+ns,(function(){self.deleteQuestion(type,questionID,this)})),$(moveUp).on("click"+ns,(function(){var currentPosition;if("instructions"==type)currentPosition=parseInt($(this).closest(".survey-item").attr("id").split("-")[1]);else{var currentQuestionNumber=$(this).closest(".survey-item").data("number");currentPosition=questionNumbers[currentQuestionNumber]}if(currentPosition>1){var movingItem,newPosition=currentPosition-1;movingItem="instructions"==type?$("#instructions-"+currentPosition).detach():$("#question-"+questionID).detach(),"question"==layout[newPosition].type?$("#question-"+layout[newPosition].id).before(movingItem):"instructions"==layout[newPosition].type?$("#instructions-"+newPosition).before(movingItem):$("#section-break-"+newPosition).parent().before(movingItem),self.rePosition(item,currentPosition,newPosition)}})),$(moveDown).on("click"+ns,(function(){var currentPosition;if("instructions"==type)currentPosition=parseInt($(this).closest(".survey-item").attr("id").split("-")[1]);else{var currentQuestionNumber=$(this).closest(".survey-item").data("number");currentPosition=questionNumbers[currentQuestionNumber]}if(currentPosition<Object.keys(layout).length){var movingItem,newPosition=currentPosition+1;movingItem="instructions"==type?$("#instructions-"+currentPosition).detach():$("#question-"+questionID).detach(),"question"==layout[newPosition].type?$("#question-"+layout[newPosition].id).after(movingItem):"instructions"==layout[newPosition].type?$("#instructions-"+newPosition).after(movingItem):$("#section-break-"+newPosition).parent().after(movingItem),self.rePosition(item,currentPosition,newPosition)}}))),type){case"instructions":case"text":break;case"number":$("#answer-"+questionID).validate({rules:{min:{required:!1,digits:!0,lessThanMax:!0},max:{required:!1,digits:!0,greaterThanMin:!0}},messages:{min:{digits:"Only integers allowed"},max:{digits:"Only integers allowed"}},errorClass:"req",focusCleanup:!0});break;case"multichoice":var multipleCheckbox=$("#multiple-"+questionID),multipleCount=$("#multiple-count-"+questionID);multipleCount.prev().off("click"+ns).on("click"+ns,(function(){if(multipleCheckbox.prop("checked")){var multiple=parseInt(multipleCount.html());multiple>2?(multipleCount.html(multiple-1),self.saveQuestion(type,questionID)):2==multiple&&(multipleCount.html(1),multipleCheckbox.prop("checked",!1),self.saveQuestion(type,questionID))}})),multipleCount.next().off("click"+ns).on("click"+ns,(function(){if(multipleCheckbox.prop("checked")){var multiple=parseInt(multipleCount.html()),optionsCount=$(".choice-"+questionID).length;$("#other-"+questionID).prop("checked")&&optionsCount++,multiple<optionsCount&&(multipleCount.html(multiple+1),self.saveQuestion(type,questionID))}}));var multichoiceEvents=function(){var deleteOption=$(".choice-"+questionID).next();deleteOption.off("click"+ns).on("click"+ns,(function(){var eq,thisItem,$this=$(this),optionInput=$this.prev(),currentPosition=(optionInput.val(),parseInt($this.closest(".media").attr("id").split("-")[1])),currentRow=$this.closest(".row"),index=parseInt(currentRow.attr("id").split("-")[3]);if($(".choice-"+questionID).length>1){currentRow.remove(),$("#choice-l10n-row-"+questionID+"-"+index).remove();for(var newIndex,optionsCount=$(".choice-"+questionID).length,i=index+1;i<=optionsCount;i++)newIndex=i-1,$("#choice-row-"+questionID+"-"+i).attr("id","choice-row-"+questionID+"-"+newIndex),$("#choice-l10n-row-"+questionID+"-"+i).attr("id","choice-l10n-row-"+questionID+"-"+newIndex),$("#choice-from-"+questionID+"-"+i).attr("id","choice-from-"+questionID+"-"+newIndex);var multiple=parseInt(multipleCount.html());$("#other-"+questionID).prop("checked")&&optionsCount++,multiple>optionsCount&&(multipleCount.html(optionsCount),1==optionsCount&&multipleCheckbox.prop("checked",!1)),self.saveQuestion(type,questionID)}else optionInput.val("");i=currentPosition+1;for(var len=Object.keys(layout).length;i<=len;i++)(thisItem=layout[i]).displayLogic&&thisItem.displayLogic.id==questionID&&((eq=thisItem.displayLogic.eq)==index?(delete thisItem.displayLogic,$("#logic-select-"+i).val("").trigger("change")):eq>index&&(thisItem.displayLogic.eq--,$("#sub-logic-select-"+i).val(eq-1).trigger("change")))})),deleteOption.next().off("click"+ns).on("click"+ns,(function(){for(var newIndex,$this=$(this),currentRow=$this.closest(".row"),index=parseInt(currentRow.attr("id").split("-")[3]),i=$(".choice-"+questionID).length-1;i>index;i--)newIndex=i+1,$("#choice-row-"+questionID+"-"+i).attr("id","choice-row-"+questionID+"-"+newIndex),$("#choice-l10n-row-"+questionID+"-"+i).attr("id","choice-l10n-row-"+questionID+"-"+newIndex),$("#choice-from-"+questionID+"-"+i).attr("id","choice-from-"+questionID+"-"+newIndex);newIndex=index+1,currentRow.after(newChoice.replace("-0","-"+newIndex)),$("#choice-l10n-row-"+questionID+"-"+index).after(newChoiceL10n.replace(/-0/g,"-"+newIndex)),$("#name-"+questionID).trigger("change");i=parseInt($this.closest(".media").attr("id").split("-")[1])+1;for(var eq,thisItem,len=Object.keys(layout).length;i<=len;i++)(thisItem=layout[i]).displayLogic&&thisItem.displayLogic.id==questionID&&(eq=thisItem.displayLogic.eq)>index&&(thisItem.displayLogic.eq++,self.logicSubOptions(i,questionID),$("#sub-logic-select-"+i).val(eq+1).trigger("change"));inputEvents(),multichoiceEvents()})),$("#other-"+questionID).off("change"+ns).on("change"+ns,(function(){if($(this).prop("checked"))$("#other-label-"+questionID).prop("disabled",!1),$("#other-l10n-row-"+questionID).removeClass("hide").show();else{$("#other-label-"+questionID).prop("disabled",!0),$("#other-l10n-row-"+questionID).hide();var multiple=parseInt(multipleCount.html()),optionsCount=$(".choice-"+questionID).length;multiple>optionsCount&&(multipleCount.html(optionsCount),1==optionsCount&&multipleCheckbox.prop("checked",!1))}self.saveQuestion(type,questionID)})),multipleCheckbox.off("change"+ns).on("change"+ns,(function(){if(multipleCheckbox.prop("checked")){parseInt(multipleCount.html());var optionsCount=$(".choice-"+questionID).length;$("#other-"+questionID).prop("checked")&&optionsCount++,optionsCount>1?multipleCount.html(2):multipleCheckbox.prop("checked",!1)}else multipleCount.html(1);self.saveQuestion(type,questionID)}))};multichoiceEvents();break;case"likert":var likertEvents=function(){$("#scale-"+questionID).on("change"+ns,(function(){$("#display-"+questionID).empty();var choicesRow=$("#choices-l10n-row-"+questionID);if(choicesRow.length){choicesRow.prev().remove();for(var i=0;i<5;i++)choicesRow.next().remove();choicesRow.remove()}thisQuestion.options_l10n=[];var scale=$(this).val();if(scale){var result=self.likertOptionsHtml(questionID,scale),choicesL10n=result.choicesL10n,displayOptions=result.displayOptions;$("#display-"+questionID).append(displayOptions);var currentPosition=parseInt($(this).closest(".media").attr("id").split("-")[1]);$("#translation-"+currentPosition).append(choicesL10n),inputEvents(),likertEvents()}self.saveQuestion("likert",questionID)}))};likertEvents();break;case"heatmap":multichoiceEvents=function(){$(".choice-"+questionID).next().off("click"+ns).on("click"+ns,(function(){var $this=$(this),currentPosition=parseInt($this.closest(".media").attr("id").split("-")[1]);if($(".choice-"+questionID).length>1){var currentRow=$this.closest(".row"),index=parseInt(currentRow.attr("id").split("-")[3]);currentRow.remove(),$("#choice-l10n-row-"+questionID+"-"+index).remove();for(var newIndex,optionsCount=$(".choice-"+questionID).length,i=index+1;i<=optionsCount;i++)newIndex=i-1,$("#choice-row-"+questionID+"-"+i).attr("id","choice-row-"+questionID+"-"+newIndex),$("#choice-json-"+questionID+"-"+i).attr("id","choice-json-"+questionID+"-"+newIndex),$("#choice-row-"+questionID+"-"+newIndex+" > .button").html("Add region "+(newIndex+1)),$("#choice-l10n-row-"+questionID+"-"+i).attr("id","choice-l10n-row-"+questionID+"-"+newIndex),$("#choice-from-"+questionID+"-"+i).attr("id","choice-from-"+questionID+"-"+newIndex)}else $this.hide().prev().val("").prop("disabled",!0).prev().addClass("secondary");var source=sources[questionID];if(void 0!==source){var callback=function(feature){var region=feature.get("region");if(region==index)source.removeFeature(feature);else if(region>index){var newRegion=region-1;feature.set("region",newRegion);var geojson=format.writeFeatureObject(feature,{decimals:0});$("#choice-json-"+questionID+"-"+newRegion).val(JSON.stringify(geojson))}return!1};source.forEachFeature(callback)}self.saveQuestion("heatmap",questionID);var region,thisItem,thisQuestionID,thisQuestionSettings,layoutLength=Object.keys(layout).length;for(i=1;i<=layoutLength;i++)"question"==(thisItem=layout[i]).type&&(thisQuestionID=thisItem.id,(thisQuestionSettings=questions[thisQuestionID].settings).pipeImage&&thisQuestionSettings.pipeImage.id==questionID&&((region=thisQuestionSettings.pipeImage.region)==index?(delete thisQuestionSettings.pipeImage,$("#pipe-"+thisQuestionID).val("").trigger("change")):region>index&&(thisQuestionSettings.pipeImage.region--,$("#pipe-"+thisQuestionID).empty().append(self.pipeOptionsHtml(thisQuestionID)).trigger("change")))),i>currentPosition&&thisItem.displayLogic&&thisItem.displayLogic.id==questionID&&((region=thisItem.displayLogic.selectedRegion)==index?(delete thisItem.displayLogic,$("#logic-select-"+i).val("").trigger("change")):region>index&&(thisItem.displayLogic.selectedRegion--,$("#sub-logic-select-"+i).val(region-1).trigger("change")))})),$(".choice-define-"+questionID).off("click"+ns).on("click"+ns,(function(){var $this=$(this),currentRow=$this.closest(".row"),index=parseInt(currentRow.attr("id").split("-")[3]);questions[questionID].settings.regions;if(currentRow.parent().find(".defining").removeClass("defining"),$this.addClass("defining"),$this.hasClass("secondary")){var newIndex=index+1;currentRow.after(newChoice.replace(/-0/g,"-"+newIndex)),$("#choice-row-"+questionID+"-"+newIndex+" > .button").html("Add region "+(newIndex+1));var choiceL10nRow='<div id="choice-l10n-row-'+questionID+"-"+index+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+questionID+"-"+index+'" class="translate-from"></div></div><div class="columns medium-6"><input class="choice-l10n-'+questionID+'" type="text" placeholder="Type translation..."></div></div></div></div>';0==index?$("#choices-l10n-row-"+questionID).after(choiceL10nRow):$("#choice-l10n-row-"+questionID+"-"+(index-1)).after(choiceL10nRow),inputEvents(),multichoiceEvents(),$this.removeClass("secondary").next().next().prop("disabled",!1).next().removeClass("hide").show()}var source=sources[questionID];if(void 0!==source){var callback=function(feature){if(feature.get("region")==index){var style=new Style({fill:new Fill({color:"#ffc0cb"}),stroke:new Stroke({color:"red"})});feature.setStyle(style)}else feature.setStyle(null);return!1};source.forEachFeature(callback);var draw=draws[questionID];draw.set("questionID",questionID,!0),draw.set("region",index,!0),maps[questionID].addInteraction(draw)}}))};multichoiceEvents();var minusClick=$("#clicks-row-"+questionID).children().first();minusClick.off("click"+ns).on("click"+ns,(function(){var $this=$(this),value=parseInt($this.next().html());value>1&&(value--,questions[questionID].settings.numClicks=value,self.saveQuestion(type,questionID),$this.next().html(" "+value+" "))})),minusClick.next().next().off("click"+ns).on("click"+ns,(function(){var $prev=$(this).prev(),value=parseInt($prev.html());value++,thisQuestion.settings.numClicks=value,self.saveQuestion(type,questionID),$prev.html(" "+value+" ")}))}$item.foundation()},deleteQuestion:function(type,questionID,deleteBtn){var currentPosition,layout=this.data.layout;if("instructions"==type)currentPosition=parseInt($(deleteBtn).closest(".survey-item").attr("id").split("-")[1]);else{var questionNumber=$("#question-"+questionID).data("number");currentPosition=questionNumbers[questionNumber],delete draws[questionID],delete maps[questionID],delete sources[questionID]}if(this.rePosition(layout[currentPosition],currentPosition,null),"instructions"==type?$("#instructions-"+currentPosition).remove():$("#question-"+questionID).remove(),"instructions"!=type){var ajaxURL=S3.Ap.concat("/dc/question/")+questionID+"/delete.json";this.ajaxMethod({url:ajaxURL,type:"POST",dataType:"json",success:function(){},error:function(jqXHR,textStatus,errorThrown){var msg;msg="UNAUTHORIZED"==errorThrown?i18n.gis_requires_login:jqXHR.responseText,console.log(msg)}})}},heatMap:function(questionID,file,load){var self=this,url=S3.Ap.concat("/default/download/"+file);$("<img>").attr("src",url).on("load",(function(){var width=this.width,height=this.height;$("#map-"+questionID).empty();var extent=[0,0,width,height],projection=new Projection({code:"preview-image",units:"pixels",extent:extent}),raster=new ImageLayer({source:new Static({url:url,projection:projection,imageExtent:extent})}),source=new VectorSource({wrapX:!1});sources[questionID]=source;var vector=new VectorLayer({source:source}),map=new Map({controls:[],interactions:[],layers:[raster,vector],target:"map-"+questionID,view:new View({projection:projection,center:getCenter(extent),zoom:1,maxZoom:1})});maps[questionID]=map,format=new GeoJSON({featureProjection:projection});var draw=new Draw({source:source,type:"Polygon"});if(draws[questionID]=draw,draw.on("drawstart",(function(event){var region=draw.get("region"),callback=function(feature){return feature.get("region")==region&&(source.removeFeature(feature),!0)};source.forEachFeature(callback)})),draw.on("drawend",(function(event){var feature=event.feature,questionID=draw.get("questionID"),region=draw.get("region");feature.set("region",region);var geojson=format.writeFeatureObject(feature,{decimals:0});$("#choice-json-"+questionID+"-"+region).val(JSON.stringify(geojson)).prev().removeClass("defining"),self.saveQuestion("heatmap",questionID),map.removeInteraction(draw)})),load)for(var feature,geojson,region,regions=self.data.questions[questionID].settings.regions||[],i=0,len=regions.length;i<len;i++)(region=regions[i])&&"null"!=region&&(geojson=JSON.parse(region),feature=format.readFeatureFromObject(geojson),source.addFeature(feature))}))},likertOptionsHtml:function(questionID,scale){var displayOptions,choicesL10n="",optionsL10nHidden=" hide";if(6==scale)displayOptions='<ul><li><i class="ucce ucce-smiley-1"> </i></li><li><i class="ucce ucce-smiley-2"> </i></li><li><i class="ucce ucce-smiley-3"> </i></li><li><i class="ucce ucce-smiley-4"> </i></li><li><i class="ucce ucce-smiley-6"> </i></li></ul>';else if(7==scale)displayOptions='<ul><li><i class="ucce ucce-smiley-3"> </i></li><li><i class="ucce ucce-smiley-4"> </i></li><li><i class="ucce ucce-smiley-5"> </i></li></ul>';else{var thisOptionL10n,options=likertOptions[scale],optionsLength=options.length,optionsL10n=this.data.questions[questionID].options_l10n||[];displayOptions="<ul>",optionsL10nHidden="";for(var i=0;i<optionsLength;i++)displayOptions+="<li>"+options[i]+"</li>",thisOptionL10n=optionsL10n[i]||"",choicesL10n+='<div id="choice-l10n-row-'+questionID+"-"+i+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+questionID+"-"+i+'" class="translate-from">'+options[i]+'</div></div><div class="columns medium-6"><input class="choice-l10n-'+questionID+'" type="text" placeholder="Type translation..." value="'+thisOptionL10n+'"></div></div></div></div>';displayOptions+="</ul>"}return{choicesL10n:'<div class="row'+optionsL10nHidden+'"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row'+optionsL10nHidden+'" id="choices-l10n-row-'+questionID+'"><div class="columns medium-1"></div><div class="columns medium-11"><label>Choices</label></div></div>'+choicesL10n,displayOptions:displayOptions}},pipeOptionsHtml:function(questionID){var img,pipeImage,thisQuestion=this.data.questions[questionID],optionsHtml='<option value="">select question</option>';thisQuestion&&thisQuestion.settings&&thisQuestion.settings.pipeImage&&(pipeImage=thisQuestion.settings.pipeImage);for(var i=0,len=imageOptions.length;i<len;i++)(img=imageOptions[i]).id!=questionID&&(pipeImage&&pipeImage.id==img.id&&pipeImage.region==img.region?optionsHtml+="<option selected>"+img.label+"</option>":optionsHtml+="<option>"+img.label+"</option>");return optionsHtml},updateImageOptions:function(load,deletedQuestionID){var item,base_label,label,options,regions,thisQuestion,thisQuestionID,thisQuestionSettings,thisQuestionType,questionNumber=0,layout=this.data.layout,layoutLength=Object.keys(layout).length,questions=this.data.questions;imageOptions=[];for(var position=1;position<=layoutLength;position++)if("break"!=(item=layout[position]).type&&"instructions"!=item.type&&(questionNumber++,void 0!==(thisQuestion=questions[thisQuestionID=item.id])&&(thisQuestionSettings=thisQuestion.settings,thisQuestionType=thisQuestion.type,load?questionNumbers[questionNumber]=position:(13!=thisQuestionType&&$("#pipe-"+thisQuestionID).empty().append(this.pipeOptionsHtml(thisQuestionID)),deletedQuestionID&&thisQuestionSettings.pipeImage&&thisQuestionSettings.pipeImage.id==deletedQuestionID&&(delete thisQuestionSettings.pipeImage,$("#preview-"+thisQuestionID).addClass("preview-empty").empty())),thisQuestion.file)))if(13==thisQuestionType){if(options=thisQuestion.options,regions=thisQuestionSettings.regions){base_label="Q"+questionNumber+" Heatmap; ";for(var i=0,len=regions.length;i<len;i++)label=base_label+"'"+options[i]+"'",imageOptions.push({label:label,id:thisQuestionID,region:i})}}else label="Q"+questionNumber+" "+typesToText[thisQuestion.type],imageOptions.push({label:label,id:thisQuestionID})},logicOptionsHtml:function(questionID,currentPosition){var displayLogicID,questionNumber,qtype,position,thisQuestion,thisQuestionID,optionsHtml='<option value="">select question</option>',layout=this.data.layout,displayLogic=layout[currentPosition].displayLogic,questions=this.data.questions;displayLogic&&(displayLogicID=displayLogic.id);var posnToNumber={};for(questionNumber=1;questionNumber<=Object.keys(questionNumbers).length;questionNumber++)posnToNumber[position=questionNumbers[questionNumber]]=questionNumber;for(position=1;position<currentPosition;position++)void 0!==(thisQuestionID=layout[position].id)&&(thisQuestion=questions[thisQuestionID],"number"!=(qtype=typesToText[thisQuestion.type])&&"multichoice"!=qtype&&"likert"!=qtype&&"heatmap"!=qtype||(optionsHtml+='<option value="'+thisQuestionID+'"'+(thisQuestionID==displayLogicID?" selected":"")+">"+("Q"+(questionNumber=posnToNumber[position])+": "+truncate(thisQuestion.name||""))+"</option>"));return optionsHtml},logicSubOptions:function(currentPosition,logicQuestionID){var label,ns=this.eventNamespace,self=this,displayLogic=this.data.layout[currentPosition].displayLogic,logicQuestion=this.data.questions[logicQuestionID],type=typesToText[logicQuestion.type];if("number"==type){var displayLogicGreaterThan,displayLogicLessThan,displayLogicEquals="",value="";displayLogic&&(displayLogicEquals=displayLogic.eq||"",displayLogicGreaterThan=displayLogic.gt,displayLogicLessThan=displayLogic.lt,displayLogicEquals?value=displayLogicEquals:displayLogicLessThan?value=displayLogicLessThan:displayLogicGreaterThan&&(value=displayLogicGreaterThan));var hide,row1='<select id="logic-operator-1-'+currentPosition+'">';row1+=!displayLogic||displayLogicEquals?'<option value="eq" selected>equal to ( = )</option>':'<option value="eq">equal to ( = )</option>',displayLogicLessThan?(row1+='<option value="lt" selected>less than ( &lt; )</option>',row1+='<option value="gt">more than ( &gt; )</option>'):(row1+='<option value="lt">less than ( &lt; )</option>',row1+=displayLogicGreaterThan?'<option value="gt" selected>more than ( &gt; )</option>':'<option value="gt">more than ( &gt; )</option>'),row1+='</select><input id="logic-term-1-'+currentPosition+'" type="number" placeholder="type number" value="'+value+'">',$("#logic-response-"+currentPosition).html(row1),displayLogicEquals||!displayLogicLessThan&&!displayLogicGreaterThan?(value="",hide=" hide"):(hide="",value=displayLogicLessThan&&displayLogicGreaterThan?displayLogicGreaterThan:"");var row2='<div class="row'+hide+'"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-2"><label class="fleft">AND</label></div><div class="columns medium-10"><select id="logic-operator-2-'+currentPosition+'">'+(!displayLogicLessThan&&displayLogicGreaterThan?'<option value="lt" selected>less than ( &lt; )</option><option value="gt">more than ( &gt; )</option>':'<option value="lt">less than ( &lt; )</option><option value="gt" selected>more than ( &gt; )</option>')+'</select><input id="logic-term-2-'+currentPosition+'" type="number" placeholder="type number" value="'+value+'"></div></div></div></div>',logicResponseRow=$("#logic-response-row-"+currentPosition);logicResponseRow.after(row2);var operator,logicOperator1=$("#logic-operator-1-"+currentPosition),logicOperator2=$("#logic-operator-2-"+currentPosition),logicTerm1=$("#logic-term-1-"+currentPosition),logicTerm2=$("#logic-term-2-"+currentPosition);return logicOperator1.on("change"+ns,(function(){operator=$(this).val(),value=parseInt(logicTerm1.val()),displayLogic={id:logicQuestionID},"eq"==operator?(logicResponseRow.next().hide(),value&&(displayLogic.eq=value)):"gt"==operator?(logicResponseRow.next().removeClass("hide").show(),logicOperator2.val("lt"),value&&(displayLogic.gt=value),(value=parseInt(logicTerm2.val()))&&(displayLogic.lt=value)):"lt"==operator&&(logicResponseRow.next().removeClass("hide").show(),logicOperator2.val("gt"),value&&(displayLogic.lt=value),(value=parseInt(logicTerm2.val()))&&(displayLogic.gt=value)),self.data.layout[currentPosition].displayLogic=displayLogic,self.saveLayout()})),logicOperator2.on("change"+ns,(function(){operator=$(this).val(),value=logicTerm2.val(),displayLogic={id:logicQuestionID},"gt"==operator?(logicOperator1.val("lt"),value&&(displayLogic.gt=parseInt(value)),(value=logicTerm1.val())&&(displayLogic.lt=parseInt(value))):"lt"==operator&&(logicOperator1.val("gt"),value&&(displayLogic.lt=value),(value=logicTerm1.val())&&(displayLogic.gt=parseInt(value))),self.data.layout[currentPosition].displayLogic=displayLogic,self.saveLayout()})),logicTerm1.on("change"+ns,(function(){(value=$(this).val())?(displayLogic={id:logicQuestionID},"eq"==(operator=logicOperator1.val())?displayLogic.eq=parseInt(value):("gt"==operator?displayLogic.gt=parseInt(value):displayLogic.lt=parseInt(value),(value=logicTerm2.val())&&("gt"==(operator=logicOperator2.val())?displayLogic.gt=parseInt(value):displayLogic.lt=parseInt(value))),self.data.layout[currentPosition].displayLogic=displayLogic):(value=logicTerm2.val())?(displayLogic={id:logicQuestionID},"gt"==(operator=logicOperator1.val())?displayLogic.gt=parseInt(value):displayLogic.lt=parseInt(value),self.data.layout[currentPosition].displayLogic=displayLogic):delete self.data.layout[currentPosition].displayLogic,self.saveLayout()})),void logicTerm2.on("change"+ns,(function(){(value=$(this).val())?(displayLogic={id:logicQuestionID},"gt"==(operator=logicOperator2.val())?displayLogic.gt=parseInt(value):displayLogic.lt=parseInt(value),(value=logicTerm1.val())&&("gt"==(operator=logicOperator1.val())?displayLogic.gt=parseInt(value):displayLogic.lt=parseInt(value)),self.data.layout[currentPosition].displayLogic=displayLogic):(value=logicTerm1.val())?(displayLogic={id:logicQuestionID},"eq"==(operator=logicOperator1.val())?displayLogic.eq=parseInt(value):"gt"==operator?displayLogic.gt=parseInt(value):displayLogic.lt=parseInt(value),self.data.layout[currentPosition].displayLogic=displayLogic):delete self.data.layout[currentPosition].displayLogic,self.saveLayout()}))}"heatmap"==type?(label="region",operator="selectedRegion"):(label="option",operator="eq");var displayLogicOption,options=logicQuestion.options,subOptionSelect='<select id="sub-logic-select-'+currentPosition+'"><option value="">select '+label+"</option>";displayLogic&&(displayLogicOption=displayLogic[operator]);for(var i=0,len=options.length;i<len;i++)subOptionSelect+='<option value="'+i+'"'+(i==displayLogicOption?" selected":"")+">"+options[i]+"</option>";if("multichoice"==type){var otherLabel=logicQuestion.settings.other;otherLabel&&(subOptionSelect+='<option value="_other"'+("_other"==displayLogicOption?" selected":"")+">"+otherLabel+"</option>")}subOptionSelect+="</select>",$("#logic-response-"+currentPosition).html(subOptionSelect),$("#sub-logic-select-"+currentPosition).on("change"+ns,(function(){var newDisplayLogic={id:logicQuestionID};newDisplayLogic[operator]=parseInt($(this).val()),self.data.layout[currentPosition].displayLogic=newDisplayLogic,self.saveLayout()}))},logicSelected:function(logicSelect,currentPosition){var value=logicSelect.val();$("#logic-response-"+currentPosition).empty(),$("#logic-response-row-"+currentPosition).next().remove(),value?this.logicSubOptions(currentPosition,parseInt(value)):(delete this.data.layout[currentPosition].displayLogic,this.saveLayout())},deleteImage:function(questionID){var self=this,preview=$("#preview-"+questionID);if(!preview.hasClass("preview-empty")){var ajaxURL=S3.Ap.concat("/dc/question/")+questionID+"/image_delete.json";this.ajaxMethod({url:ajaxURL,type:"POST",dataType:"json",success:function(){preview.empty().addClass("preview-empty"),delete self.data.questions[questionID].file,delete imageFiles[questionID],self.updateImageOptions(!1,questionID)},error:function(jqXHR,textStatus,errorThrown){var msg;msg="UNAUTHORIZED"==errorThrown?i18n.gis_requires_login:jqXHR.responseText,console.log(msg)}})}},addSectionBreak:function(newPosition,page,load){var ns=this.eventNamespace,thisElements=0;if(0==newPosition){pages[1]=newPosition;var layout=this.data.layout;if(layoutLength=Object.keys(layout).length)for(var position=1;position<=layoutLength&&"break"!=layout[position].type;position++)thisElements++;pageElements[1]=thisElements;var sectionBreak='<div class="row"><div class="section-break medium-11 columns" id="section-break-0" data-page="1"><span>PAGE 1 ('+(1==thisElements?"1 ELEMENT":thisElements+" ELEMENTS")+')</span></div><div class="medium-1 columns"><i class="ucce ucce-up-alt"> </i></div></div>';$(this.element).parent().append(sectionBreak)}else{if(page++,load){layout=this.data.layout;var layoutLength=Object.keys(layout).length;for(position=newPosition+1;position<=layoutLength&&"break"!=layout[position].type;position++)thisElements++;pageElements[page]=thisElements,pages[page]=newPosition}else this.rePosition({type:"break"},null,newPosition),thisElements=pageElements[page];var readOnly=this.options.readOnly;sectionBreak='<div class="row"><div class="section-break medium-11 columns" id="section-break-'+newPosition+'" data-page="'+page+'"><span>PAGE '+page+" ("+(1==thisElements?"1 ELEMENT":thisElements+" ELEMENTS")+')</span></div><div class="medium-1 columns">'+(readOnly?"":'<i class="ucce ucce-delete-page"> </i>')+'<i class="ucce ucce-up-alt"> </i></div></div>';if(readOnly)$(this.element).parent().append(sectionBreak);else{layout=this.data.layout;if(load||newPosition==Object.keys(layout).length)$("#survey-droppable").before(sectionBreak);else{var previousPosition=newPosition-1,previousItem=layout[previousPosition];"break"==previousItem.type?$("#section-break-"+previousPosition).parent().after(sectionBreak):"instructions"==previousItem.type?$("#instructions-"+previousPosition).after(sectionBreak):$("#question-"+previousItem.id).after(sectionBreak)}var self=this;$("#section-break-"+newPosition).next().children(".ucce-delete-page").on("click"+ns,(function(){var $el=$(this).parent().prev(),currentPage=$el.data("page"),currentPosition=parseInt($el.attr("id").split("-")[2]);self.deleteSectionBreak(currentPage,currentPosition)}))}}$("#section-break-"+newPosition).next().children(".ucce-up-alt").on("click"+ns,(function(){var $this=$(this),currentPage=$this.parent().prev().data("page");$this.hasClass("ucce-up-alt")?($('.survey-item[data-page="'+currentPage+'"]').hide(),$this.removeClass("ucce-up-alt").addClass("ucce-down-alt")):($('.survey-item[data-page="'+currentPage+'"]').show(),$this.removeClass("ucce-down-alt").addClass("ucce-up-alt"))}))},deleteSectionBreak:function(currentPage,currentPosition){$('.survey-item[data-page="'+currentPage+'"]').show(),this.rePosition({type:"break"},currentPosition,null),$("#section-break-"+currentPosition).parent().remove()},rePosition:function(item,currentPosition,newPosition){var questionID,currentPage,newPage,oldQuestionNumber,newQuestionNumber,thisElements,thisElementsText,itemType=item.type,layout=this.data.layout,layoutLength=Object.keys(layout).length,pagesLength=Object.keys(pages).length;if("question"==itemType&&(questionID=item.id),currentPosition)if("instructions"==itemType)currentPage=$("#instructions-"+currentPosition).data("page");else if("question"==itemType){var oldElement=$("#question-"+questionID);currentPage=oldElement.data("page"),oldQuestionNumber=oldElement.data("number")}else"break"==itemType&&(currentPage=$("#section-break-"+currentPosition).data("page"));if(newPosition){if(1==newPosition)newPage=1,newQuestionNumber=1;else{var previousPosition,previousItem=layout[previousPosition=currentPosition==newPosition-1?newPosition:newPosition-1],previousType=previousItem.type;if("instructions"==previousType)newPage=$("#instructions-"+previousPosition).data("page");else if("question"==previousType){var previousQuestionID=previousItem.id,previousElement=$("#question-"+previousQuestionID);newPage=previousElement.data("page"),newQuestionNumber=previousElement.data("number")+1}else"break"==previousType&&(newPage=$("#section-break-"+previousPosition).data("page"));if("question"==itemType){var questionNumbersLength=Object.keys(questionNumbers).length;if(questionNumbersLength)if(newPosition>layoutLength)newQuestionNumber=currentPosition?questionNumbersLength:questionNumbersLength+1;else{for(var p=newPosition-1;p>0;p--)if("question"==(thisItem=layout[p]).type){previousQuestionID=thisItem.id;newQuestionNumber=$("#question-"+previousQuestionID).data("number")+1;break}newQuestionNumber||(newQuestionNumber=1)}else newQuestionNumber=1}}"break"==itemType&&newPage++}if(currentPosition&&newPosition){if(currentPosition==newPosition-1||currentPosition==newPosition+1){var swapItem=layout[newPosition],swapItemType=swapItem.type;if("break"==swapItemType){var currentItem=layout[currentPosition];layout[currentPosition]=swapItem,layout[newPosition]=currentItem,($currentItem=$(oldQuestionNumber?"#question-"+questionID:"#instructions-"+currentPosition)).data("page",newPage),$currentItem.attr("data-page",newPage),$("#section-break-"+newPosition).attr("id","section-break-"+currentPosition),currentPosition==newPosition-1?pages[newPage]=currentPosition:pages[currentPage]=currentPosition,pageElements[currentPage]--,pageElements[newPage]++,thisElementsText=1==(thisElements=pageElements[currentPage])?"1 ELEMENT":thisElements+" ELEMENTS",$("#section-break-"+pages[currentPage]+" > span").html("PAGE "+currentPage+" ("+thisElementsText+")"),thisElementsText=1==(thisElements=pageElements[newPage])?"1 ELEMENT":thisElements+" ELEMENTS",$("#section-break-"+pages[newPage]+" > span").html("PAGE "+newPage+" ("+thisElementsText+")"),"instructions"==itemType?($("#instructions-"+currentPosition).attr("id","instructions-"+newPosition),$("#do-"+currentPosition).attr("id","do-"+newPosition),$("#say-"+currentPosition).attr("id","say-"+newPosition),$("#do-l10n-"+currentPosition).attr("id","do-"+newPosition),$("#say-l10n-"+currentPosition).attr("id","say-"+newPosition)):questionNumbers[oldQuestionNumber]=newPosition,$("#edit-"+currentPosition).attr("id","edit-"+newPosition),$("#logic-"+currentPosition).attr("id","logic-"+newPosition),$("#logic-select-"+currentPosition).attr("id","logic-select-"+newPosition),$("#sub-logic-select-"+currentPosition).attr("id","sub-logic-select-"+newPosition),$("#logic-response-"+currentPosition).attr("id","logic-response-"+newPosition),$("#logic-response-row-"+currentPosition).attr("id","logic-response-row-"+newPosition),$("#logic-operator-1-"+currentPosition).attr("id","logic-operator-1-"+newPosition),$("#logic-operator-2-"+currentPosition).attr("id","logic-operator-2-"+newPosition),$("#logic-term-1-"+currentPosition).attr("id","logic-term-1-"+newPosition),$("#logic-term-2-"+currentPosition).attr("id","logic-term-2-"+newPosition),$("#translation-"+currentPosition).attr("id","translation-"+newPosition),$currentItem.find("li.tabs-title > a").each((function(){var $this=$(this);oldHref=$this.attr("href"),newHref=(newHref=oldHref.split("-")[0]).substring(1,newHref.length),$this.attr("href","#"+newHref+"-"+newPosition)}))}else{currentItem=layout[currentPosition];layout[currentPosition]=swapItem,layout[newPosition]=currentItem;var $currentItem,$swapItem,swapQuestionID=swapItem.id;if($currentItem=$(oldQuestionNumber?"#question-"+questionID:"#instructions-"+currentPosition),$swapItem=$("question"==swapItemType?"#question-"+swapQuestionID:"#instructions-"+newPosition),oldQuestionNumber&&"question"==swapItemType)$currentItem.data("number",newQuestionNumber),$("#qlabel-"+questionID).html("Q"+newQuestionNumber),$("#qlabel-l10n-"+questionID).html("Q"+newQuestionNumber),$swapItem.data("number",oldQuestionNumber),$("#qlabel-"+swapQuestionID).html("Q"+oldQuestionNumber),$("#qlabel-l10n-"+swapQuestionID).html("Q"+oldQuestionNumber);else if(oldQuestionNumber)questionNumbers[oldQuestionNumber]=newPosition;else if("question"==swapItemType){var swapQuestionNumber=$swapItem.data("number");questionNumbers[swapQuestionNumber]=currentPosition}"instructions"==swapItemType&&($("#instructions-"+newPosition).attr("id","instructions-interim"),$("#do-"+newPosition).attr("id","do-interim"),$("#say-"+newPosition).attr("id","say-interim"),$("#do-l10n-"+newPosition).attr("id","do-interim"),$("#say-l10n-"+newPosition).attr("id","say-interim")),$("#edit-"+newPosition).attr("id","edit-interim"),$("#logic-"+newPosition).attr("id","logic-interim"),$("#logic-select-"+newPosition).attr("id","logic-select-interim"),$("#logic-response-"+newPosition).attr("id","logic-response-interim"),$("#logic-response-row-"+newPosition).attr("id","logic-response-row-interim"),$("#sub-logic-select-"+newPosition).attr("id","sub-logic-select-interim"),$("#logic-operator-1-"+newPosition).attr("id","logic-operator-1-interim"),$("#logic-operator-2-"+newPosition).attr("id","logic-operator-2-interim"),$("#logic-term-1-"+newPosition).attr("id","logic-term-1-interim"),$("#logic-term-2-"+newPosition).attr("id","logic-term-2-interim"),$("#translation-"+newPosition).attr("id","translation-interim"),"instructions"==itemType&&($("#instructions-"+currentPosition).attr("id","instructions-"+newPosition),$("#do-"+currentPosition).attr("id","do-"+newPosition),$("#say-"+currentPosition).attr("id","say-"+newPosition),$("#do-l10n-"+currentPosition).attr("id","do-"+newPosition),$("#say-l10n-"+currentPosition).attr("id","say-"+newPosition)),$("#edit-"+currentPosition).attr("id","edit-"+newPosition),$("#logic-"+currentPosition).attr("id","logic-"+newPosition),$("#logic-select-"+currentPosition).attr("id","logic-select-"+newPosition),$("#logic-response-"+currentPosition).attr("id","logic-response-"+newPosition),$("#logic-response-row-"+currentPosition).attr("id","logic-response-row-"+newPosition),$("#sub-logic-select-"+currentPosition).attr("id","sub-logic-select-"+newPosition),$("#logic-operator-1-"+currentPosition).attr("id","logic-operator-1-"+newPosition),$("#logic-operator-2-"+currentPosition).attr("id","logic-operator-2-"+newPosition),$("#logic-term-1-"+currentPosition).attr("id","logic-term-1-"+newPosition),$("#logic-term-2-"+currentPosition).attr("id","logic-term-2-"+newPosition),$("#translation-"+currentPosition).attr("id","translation-"+newPosition),$currentItem.find("li.tabs-title > a").each((function(){var $this=$(this);oldHref=$this.attr("href"),newHref=(newHref=oldHref.split("-")[0]).substring(1,newHref.length),$this.attr("href","#"+newHref+"-"+newPosition)})),"instructions"==swapItemType&&($("#instructions-interim").attr("id","instructions-"+currentPosition),$("#do-interim").attr("id","do-"+currentPosition),$("#say-interim").attr("id","say-"+currentPosition),$("#do-l10n-interim").attr("id","do-"+currentPosition),$("#say-l10n-interim").attr("id","say-"+currentPosition)),$("#edit-interim").attr("id","edit-"+currentPosition),$("#logic-interim").attr("id","logic-"+currentPosition),$("#logic-select-interim").attr("id","logic-select-"+currentPosition),$("#logic-response-interim").attr("id","logic-response-"+currentPosition),$("#logic-response-row-interim").attr("id","logic-response-row-"+currentPosition),$("#sub-logic-select-interim").attr("id","sub-logic-select-"+currentPosition),$("#logic-operator-1-interim").attr("id","logic-operator-1-"+currentPosition),$("#logic-operator-2-interim").attr("id","logic-operator-2-"+currentPosition),$("#logic-term-1-interim").attr("id","logic-term-1-"+currentPosition),$("#logic-term-2-interim").attr("id","logic-term-2-"+currentPosition),$("#translation-interim").attr("id","translation-"+currentPosition),$swapItem.find("li.tabs-title > a").each((function(){var $this=$(this);oldHref=$this.attr("href"),newHref=(newHref=oldHref.split("-")[0]).substring(1,newHref.length),$this.attr("href","#"+newHref+"-"+currentPosition)})),currentPosition==newPosition-1?questionID&&swapItem.displayLogic&&swapItem.displayLogic.id==questionID&&(delete swapItem.displayLogic,$("#logic-select-"+currentPosition).val("").trigger("change")):swapQuestionID&&currentItem.displayLogic&&currentItem.displayLogic.id==swapQuestionID&&(delete currentItem.displayLogic,$("#logic-select-"+newPosition).val("").trigger("change"))}}this.updateImageOptions()}else if(newPosition){if("break"==itemType)if(newPosition>layoutLength)pages[newPage]=newPosition,pageElements[newPage]=0;else{for(var i=pagesLength;i>=newPage;i--)pages[i+1]=pages[i]+1,pageElements[i+1]=pageElements[i];pages[newPage]=newPosition;var newPageElements,previousPagePosition=pages[previousPage=newPage-1],previousPageElements=newPosition-previousPagePosition-1;previousPageElements<0&&(previousPageElements=0),newPageElements=pageElements[previousPage]-previousPageElements,pageElements[previousPage]=previousPageElements,pageElements[newPage]=newPageElements,thisElementsText=1==previousPageElements?"1 ELEMENT":previousPageElements+" ELEMENTS",$("#section-break-"+previousPagePosition+" > span").html("PAGE "+previousPage+" ("+thisElementsText+")")}else{pageElements[newPage]++;var pagePosition=pages[newPage];if(thisElementsText=1==(thisElements=pageElements[newPage])?"1 ELEMENT":thisElements+" ELEMENTS",$("#section-break-"+pagePosition+" > span").html("PAGE "+newPage+" ("+thisElementsText+")"),newPage!=pagesLength)for(i=newPage+1;i>=pagesLength;i--)pages[i]++}if(newPosition<=layoutLength){var thisNewQuestionNumber,thisOldQuestionNumber;for(i=layoutLength;i>=newPosition;i--)thisNewPosition=i+1,thisItem=layout[oldPosition=i],layout[thisNewPosition]=thisItem,"break"==thisItem.type?("break"==itemType&&(thisPage=($thisItem=$("#section-break-"+oldPosition)).data("page")+1,$thisItem.data("page",thisPage),thisElementsText=1==(thisElements=pageElements[thisPage])?"1 ELEMENT":thisElements+" ELEMENTS",$("#section-break-"+oldPosition+" > span").html("PAGE "+thisPage+" ("+thisElementsText+")")),$("#section-break-"+oldPosition).attr("id","section-break-"+thisNewPosition)):("question"==thisItem.type?(thisQuestionID=thisItem.id,thisOldQuestionNumber=($thisItem=$("#question-"+thisQuestionID)).data("number"),"question"==itemType?(thisNewQuestionNumber=thisOldQuestionNumber+1,$thisItem.data("number",thisNewQuestionNumber),$("#qlabel-"+thisQuestionID).html("Q"+thisNewQuestionNumber),$("#qlabel-l10n-"+thisQuestionID).html("Q"+thisNewQuestionNumber)):thisNewQuestionNumber=thisOldQuestionNumber,questionNumbers[thisNewQuestionNumber]=thisNewPosition):($thisItem=$("#instructions-"+thisNewPosition),$("#instructions-"+oldPosition).attr("id","instructions-"+thisNewPosition),$("#do-"+oldPosition).attr("id","do-"+thisNewPosition),$("#say-"+oldPosition).attr("id","say-"+thisNewPosition),$("#do-l10n-"+oldPosition).attr("id","do-"+thisNewPosition),$("#say-l10n-"+oldPosition).attr("id","say-"+thisNewPosition)),"break"==itemType&&(thisPage=$thisItem.data("page")+1,$thisItem.data("page",thisPage),$thisItem.attr("data-page",thisPage)),$("#edit-"+oldPosition).attr("id","edit-"+thisNewPosition),$("#logic-"+oldPosition).attr("id","logic-"+thisNewPosition),$("#logic-select-"+oldPosition).attr("id","logic-select-"+thisNewPosition),$("#logic-response-"+oldPosition).attr("id","logic-response-"+thisNewPosition),$("#logic-response-row-"+oldPosition).attr("id","logic-response-row-"+thisNewPosition),$("#sub-logic-select-"+oldPosition).attr("id","sub-logic-select-"+thisNewPosition),$("#logic-operator-1-"+oldPosition).attr("id","logic-operator-1-"+thisNewPosition),$("#logic-operator-2-"+oldPosition).attr("id","logic-operator-2-"+thisNewPosition),$("#logic-term-1-"+oldPosition).attr("id","logic-term-1-"+thisNewPosition),$("#logic-term-2-"+oldPosition).attr("id","logic-term-2-"+thisNewPosition),$("#translation-"+oldPosition).attr("id","translation-"+thisNewPosition),$thisItem.find("li.tabs-title > a").each((function(){var $this=$(this);oldHref=$this.attr("href"),newHref=(newHref=oldHref.split("-")[0]).substring(1,newHref.length),$this.attr("href","#"+newHref+"-"+thisNewPosition)})))}layout[newPosition]=item,"question"==itemType&&(questionNumbers[newQuestionNumber]=newPosition,newPosition<=layoutLength&&this.updateImageOptions())}else{if("break"==itemType){var currentPageElements=pageElements[currentPage];if(currentPageElements){var previousPage;pageElements[previousPage=currentPage-1]+=currentPageElements;previousPagePosition=pages[previousPage];thisElementsText=1==(thisElements=pageElements[previousPage])?"1 ELEMENT":thisElements+" ELEMENTS",$("#section-break-"+previousPagePosition+" > span").html("PAGE "+previousPage+" ("+thisElementsText+")")}for(i=currentPage;i<pagesLength;i++)pages[i]=pages[i+1]-1,pageElements[i]=pageElements[i+1];delete pages[pagesLength],delete pageElements[pagesLength]}else{pageElements[currentPage]--,thisElementsText=1==(thisElements=pageElements[currentPage])?"1 ELEMENT":thisElements+" ELEMENTS",$("#section-break-"+pages[currentPage]+" > span").html("PAGE "+currentPage+" ("+thisElementsText+")");for(i=currentPage+1;i<=pagesLength;i++)pages[i]--}if(currentPosition!=layoutLength){var thisItem,$thisItem,thisPage,thisNewPosition,oldPosition,oldHref,newHref,thisQuestionID,thisQuestionNumber;for(i=currentPosition;i<layoutLength;i++)thisNewPosition=i,thisItem=layout[oldPosition=i+1],layout[thisNewPosition]=thisItem,"break"==thisItem.type?("break"==itemType&&(thisPage=$("#section-break-"+oldPosition).data("page")-1,$("#section-break-"+oldPosition).data("page",thisPage),thisElementsText=1==(thisElements=pageElements[thisPage])?"1 ELEMENT":thisElements+" ELEMENTS",$("#section-break-"+oldPosition+" > span").html("PAGE "+thisPage+" ("+thisElementsText+")")),$("#section-break-"+oldPosition).attr("id","section-break-"+thisNewPosition)):("question"==thisItem.type?(thisQuestionID=thisItem.id,thisQuestionNumber=($thisItem=$("#question-"+thisQuestionID)).data("number"),"question"==itemType&&(newQuestionNumber=thisQuestionNumber-1,$thisItem.data("number",newQuestionNumber),$("#qlabel-"+thisQuestionID).html("Q"+newQuestionNumber),$("#qlabel-l10n-"+thisQuestionID).html("Q"+newQuestionNumber)),questionNumbers[thisQuestionNumber]=thisNewPosition):($thisItem=$("#instructions-"+thisNewPosition),$("#instructions-"+oldPosition).attr("id","instructions-"+thisNewPosition),$("#do-"+oldPosition).attr("id","do-"+thisNewPosition),$("#say-"+oldPosition).attr("id","say-"+thisNewPosition),$("#do-l10n-"+oldPosition).attr("id","do-"+thisNewPosition),$("#say-l10n-"+oldPosition).attr("id","say-"+thisNewPosition)),"break"==itemType&&(thisPage=$thisItem.data("page")-1,$thisItem.data("page",thisPage),$thisItem.attr("data-page",thisPage)),$("#edit-"+oldPosition).attr("id","edit-"+thisNewPosition),$("#logic-"+oldPosition).attr("id","logic-"+thisNewPosition),$("#logic-select-"+oldPosition).attr("id","logic-select-"+thisNewPosition),$("#logic-response-"+oldPosition).attr("id","logic-response-"+thisNewPosition),$("#logic-response-row-"+oldPosition).attr("id","logic-response-row-"+thisNewPosition),$("#sub-logic-select-"+oldPosition).attr("id","sub-logic-select-"+thisNewPosition),$("#logic-operator-1-"+oldPosition).attr("id","logic-operator-1-"+thisNewPosition),$("#logic-operator-2-"+oldPosition).attr("id","logic-operator-2-"+thisNewPosition),$("#logic-term-1-"+oldPosition).attr("id","logic-term-1-"+thisNewPosition),$("#logic-term-2-"+oldPosition).attr("id","logic-term-2-"+thisNewPosition),$("#translation-"+oldPosition).attr("id","translation-"+thisNewPosition),$thisItem.find("li.tabs-title > a").each((function(){var $this=$(this);oldHref=$this.attr("href"),newHref=(newHref=oldHref.split("-")[0]).substring(1,newHref.length),$this.attr("href","#"+newHref+"-"+thisNewPosition)})),questionID&&thisItem.displayLogic&&thisItem.displayLogic.id==questionID&&(delete thisItem.displayLogic,$("#logic-select-"+thisNewPosition).val("").trigger("change")))}delete layout[layoutLength],"question"==itemType&&(delete questionNumbers[Object.keys(questionNumbers).length],delete imageFiles[questionID]),this.updateImageOptions(!1,questionID)}this.saveLayout()},droppable:function(){var self=this,layout=this.data.layout,droppable='<div id="survey-droppable"><span>Drag and drop questions here</span></div>';$(this.element).parent().append(droppable),$("#survey-droppable").droppable({drop:function(event,ui){var type=ui.draggable[0].id,currentPosition=Object.keys(layout).length+1,currentPage=Object.keys(pages).length;"break"==type?self.addSectionBreak(currentPosition,currentPage):self.addQuestion(currentPosition,currentPage,type)}})},_destroy:function(){$.Widget.prototype.destroy.call(this)},loadSurvey:function(){var layout=this.data.layout;if(layout){var deleted,item,position,questionID,thisQuestion,page=1,layoutLength=Object.keys(layout).length,questions=this.data.questions;for(position=1;position<=layoutLength;position++)"question"==(item=layout[position]).type&&void 0===(thisQuestion=questions[questionID=item.id])&&(delete layout[position],deleted=!0);if(deleted){var i,oldPosition,newPosition;for(position=1;position<=layoutLength;position++)if(void 0===layout[position]){for(i=position;i<layoutLength;i++)newPosition=i,void 0===(item=layout[oldPosition=i+1])?void 0===(item=layout[oldPosition=i+2])&&oldPosition<layoutLength&&void 0===(item=layout[oldPosition=i+3])&&oldPosition<layoutLength&&void 0===(item=layout[oldPosition=i+4])&&oldPosition<layoutLength&&void 0===(item=layout[oldPosition=i+5])&&oldPosition<layoutLength&&void 0===(item=layout[oldPosition=i+6])&&oldPosition<layoutLength&&void 0===(item=layout[oldPosition=i+7])&&oldPosition<layoutLength&&void 0===(item=layout[oldPosition=i+8])&&oldPosition<layoutLength?pass:oldPosition<layoutLength&&(layout[newPosition]=item):layout[newPosition]=item;delete layout[i]}layoutLength=Object.keys(layout).length;var thisElementsText,thisElements=0;for(position=1;position<=layoutLength&&"break"!=(item=layout[position]).type;position++)thisElements++;pageElements[1]=thisElements,thisElementsText=1==thisElements?"1 ELEMENT":thisElements+" ELEMENTS",$("#section-break-0 > span").html("PAGE 1 ("+thisElementsText+")")}for(this.updateImageOptions(!0),position=1;position<=layoutLength;position++)"break"==(item=layout[position]).type?(this.addSectionBreak(position,page,!0),page++):"instructions"==item.type?this.addQuestion(position,page,"instructions",!0):(thisQuestion=questions[questionID=item.id],this.addQuestion(position,page,typesToText[thisQuestion.type],questionID))}},refresh:function(){this._unbindEvents(),this._deserialize(),this.addSectionBreak(0,0),this.options.readOnly||this.droppable(),this.loadSurvey(),this._bindEvents()},saveQuestion:function(type,questionID){if(!this.options.readOnly){var name=$("#name-"+questionID).val();if(name){var ajaxURL=S3.Ap.concat("/dc/question/")+questionID+"/update_json.json",mandatory=$("#mandatory-"+questionID).prop("checked"),data={name:name},l10n=this.data.l10n,settings={},thisQuestion=this.data.questions[questionID];if(mandatory&&(settings.requires={isNotEmpty:{}}),thisQuestion.name=name,l10n){var name_l10n=$("#name-l10n-"+questionID).val();data.name_l10n=name_l10n,thisQuestion.name_l10n=name_l10n}var pipeImage=thisQuestion.settings.pipeImage;switch(pipeImage&&(settings.pipeImage=pipeImage),type){case"text":break;case"number":var min,max;$("#min-"+questionID).hasClass("req")||(min=$("#min-"+questionID).val())&&(min=parseInt(min)),$("#max-"+questionID).hasClass("req")||(max=$("#max-"+questionID).val())&&(max=parseInt(max)),(min||max)&&(settings.requires={isIntInRange:{min:min,max:max}},mandatory&&(settings.requires.isNotEmpty={}));break;case"multichoice":var options=[];if($(".choice-"+questionID).each((function(){options.push($(this).val())})),data.options=options,thisQuestion.options=options,l10n){var options_l10n=[];$(".choice-l10n-"+questionID).each((function(){options_l10n.push($(this).val())})),data.options_l10n=options_l10n}$("#other-"+questionID).prop("checked")?(settings.other=$("#other-label-"+questionID).val()||"Other (please specify)",l10n&&(settings.otherL10n=$("#other-l10n-"+questionID).val())):(settings.other=null,l10n&&(settings.otherL10n=null)),$("#multiple-"+questionID).prop("checked")?settings.multiple=parseInt($("#multiple-count-"+questionID).html()):settings.multiple=1;break;case"likert":var scale=$("#scale-"+questionID).val();if(scale?(options=likertOptions[scale],settings.scale=parseInt(scale)):(options=[],settings.scale=null),data.options=options,thisQuestion.options=options,l10n){options_l10n=[];$(".choice-l10n-"+questionID).each((function(){options_l10n.push($(this).val())})),data.options_l10n=options_l10n}break;case"heatmap":options=[];var regions=[];if($(".choice-"+questionID).each((function(){options.push($(this).val())})),options.pop(),data.options=options,thisQuestion.options=options,l10n){options_l10n=[];$(".choice-l10n-"+questionID).each((function(){options_l10n.push($(this).val())})),data.options_l10n=options_l10n}for(var i=0,len=options.length;i<len;i++)regions.push($("#choice-json-"+questionID+"-"+i).val());settings.regions=regions;var numClicks=thisQuestion.settings.numClicks;numClicks&&(settings.numClicks=numClicks)}data.settings=settings,thisQuestion.settings=settings,"heatmap"==type&&this.updateImageOptions(),this.ajaxMethod({url:ajaxURL,type:"POST",data:JSON.stringify(data),dataType:"json",success:function(){},error:function(jqXHR,textStatus,errorThrown){var msg;msg="UNAUTHORIZED"==errorThrown?i18n.gis_requires_login:jqXHR.responseText,console.log(msg)}})}}},saveLayout:function(){if(!this.options.readOnly){var ajaxURL=S3.Ap.concat("/dc/template/")+this.recordID+"/update_json.json";this.ajaxMethod({url:ajaxURL,type:"POST",data:JSON.stringify({layout:this.data.layout}),dataType:"json",success:function(){},error:function(jqXHR,textStatus,errorThrown){var msg;msg="UNAUTHORIZED"==errorThrown?i18n.gis_requires_login:jqXHR.responseText,console.log(msg)}})}},_deserialize:function(){var value=$(this.element).val()||"{}";return this.data=JSON.parse(value),this.data},_bindEvents:function(){var self=this,ns=this.eventNamespace,surveyName=$("#survey-name");$(document).on("change.zf.tabs",(function(event,tab){if(tab){var tabText=tab.text();if("Display logic"==tabText){var currentPosition=parseInt(tab.children().first().attr("href").split("-")[1]),logicSelect=$("#logic-select-"+currentPosition);if("instructions"==(parts=tab.closest(".survey-item").attr("id").split("-"))[0])logicSelect.html(self.logicOptionsHtml(null,currentPosition));else{var questionID=parts[1];logicSelect.html(self.logicOptionsHtml(questionID,currentPosition))}self.logicSelected(logicSelect,currentPosition)}else if("Translation"==tabText){var parts;currentPosition=parseInt(tab.children().first().attr("href").split("-")[1]);if("instructions"==(parts=tab.closest(".survey-item").attr("id").split("-"))[0])$("#do-l10n-"+currentPosition).prev().html($("#do-"+currentPosition).val()),$("#say-l10n-"+currentPosition).prev().html($("#say-"+currentPosition).val());else{questionID=parts[1];var thisQuestion=self.data.questions[questionID];switch($("#name-l10n-from-"+questionID).html($("#name-"+questionID).val()),typesToText[thisQuestion.type]){case"text":case"number":case"likert":break;case"multichoice":$(".choice-"+questionID).each((function(index){$("#choice-from-"+questionID+"-"+index).html($(this).val())})),$("#other-l10n-from-"+questionID).html($("#other-label-"+questionID).val());break;case"heatmap":$(".choice-"+questionID).each((function(index){$("#choice-from-"+questionID+"-"+index).html($(this).val())}))}}}}})),this.options.readOnly||(surveyName.on("change"+ns,(function(){var name=surveyName.val(),recordID=surveyName.data("id");self.ajaxMethod({url:S3.Ap.concat("/dc/target/")+recordID+"/name.json",type:"POST",data:JSON.stringify({name:name}),dataType:"json",success:function(){},error:function(request,status,error){var msg;msg="UNAUTHORIZED"==error?i18n.gis_requires_login:request.responseText,console.log(msg)}})})),$("#survey-l10n").on("change"+ns,(function(){var l10n=$(this).val(),recordID=surveyName.data("id");self.ajaxMethod({url:S3.Ap.concat("/dc/target/")+recordID+"/l10n.json",type:"POST",data:JSON.stringify({l10n:l10n}),dataType:"json",success:function(){self.data.l10n=l10n,l10n?($("li.l10n").removeClass("hide").show(),$(".tabs").foundation(),$('div[data-magellan-expedition="fixed"] #upload-translation').prop("disabled",!1).parent().parent().parent().removeClass("hide").show()):($("li.l10n").hide(),$('div[data-magellan-expedition="fixed"] #upload-translation').prop("disabled",!0).parent().parent().parent().hide())},error:function(request,status,error){var msg;msg="UNAUTHORIZED"==error?i18n.gis_requires_login:request.responseText,console.log(msg)}})})),$(".draggable").draggable({revert:!0,revertDuration:250})),$("#upload-translation").fileupload({dataType:"json",disableImageMetaDataLoad:!0,disableImageLoad:!0,disableImageMetaDataSave:!0,disableImagePreview:!0,disableImageReferencesDeletion:!0,maxNumberOfFiles:1,url:S3.Ap.concat("/dc/template/")+self.recordID+"/upload_l10n.json",done:function(e,data){var result=data.result;if(result){var message=result.message;if(message){var callback=function(){location.reload()};"failed"==result.status?S3.showAlert(message,"error",callback):S3.showAlert(message,"success",callback)}}},fail:function(e,data){var textStatus=data.textStatus,jqXHR=data.jqXHR,httpStatus=jqXHR.status,readyState=jqXHR.readyState;"abort"==textStatus||!httpStatus&&0===readyState||("timeout"==textStatus?(message=i18n.ajax_wht+" 1 "+i18n.ajax_gvn,S3.showAlert(message,"error")):500==httpStatus&&S3.showAlert(i18n.ajax_500,"error"))}}),$("#question-bar").on("after-clone.fndtn.magellan",(function(){$("div[data-magellan-expedition-clone] #upload-translation").remove()}))},_unbindEvents:function(){var ns=this.eventNamespace;$("#survey-name").off(ns),$("#survey-l10n").off(ns);var draggable_el=$(".draggable");return null!=draggable_el.draggable("instance")&&draggable_el.draggable("destroy"),!0}})}(window.jQuery,window.loadImage,Map,View,Draw,Fill,GeoJSON,getCenter,ImageLayer,Projection,Static,Stroke,Style,VectorLayer,VectorSource)}();