/*
 2013-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js 1.8.5 (patched)

*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(c,t,u){c instanceof String&&(c=String(c));for(var a=c.length,b=0;b<a;b++){var d=c[b];if(t.call(u,d,b,c))return{i:b,v:d}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,t,u){if(c==Array.prototype||c==Object.prototype)return c;c[t]=u.value;return c};$jscomp.getGlobal=function(c){c=["object"==typeof globalThis&&globalThis,c,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var t=0;t<c.length;++t){var u=c[t];if(u&&u.Math==Math)return u}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(c,t){var u=$jscomp.propertyToPolyfillSymbol[t];if(null==u)return c[t];u=c[u];return void 0!==u?u:c[t]};
$jscomp.polyfill=function(c,t,u,a){t&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(c,t,u,a):$jscomp.polyfillUnisolated(c,t,u,a))};$jscomp.polyfillUnisolated=function(c,t,u,a){u=$jscomp.global;c=c.split(".");for(a=0;a<c.length-1;a++){var b=c[a];if(!(b in u))return;u=u[b]}c=c[c.length-1];a=u[c];t=t(a);t!=a&&null!=t&&$jscomp.defineProperty(u,c,{configurable:!0,writable:!0,value:t})};
$jscomp.polyfillIsolated=function(c,t,u,a){var b=c.split(".");c=1===b.length;a=b[0];a=!c&&a in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var d=0;d<b.length-1;d++){var e=b[d];if(!(e in a))return;a=a[e]}b=b[b.length-1];u=$jscomp.IS_SYMBOL_NATIVE&&"es6"===u?a[b]:null;t=t(u);null!=t&&(c?$jscomp.defineProperty($jscomp.polyfills,b,{configurable:!0,writable:!0,value:t}):t!==u&&(void 0===$jscomp.propertyToPolyfillSymbol[b]&&(u=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[b]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(b):$jscomp.POLYFILL_PREFIX+u+"$"+b),$jscomp.defineProperty(a,$jscomp.propertyToPolyfillSymbol[b],{configurable:!0,writable:!0,value:t})))};$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(t,u){return $jscomp.findInternal(this,t,u).v}},"es6","es3");
(function(c,t){var u=0;c.widget("s3.pivottable",{options:{showTotals:!0,ajaxURL:null,defaultChart:{type:"breakdown",axis:"rows"},renderFilter:!0,renderOptions:!0,renderChart:!0,renderTable:!0,collapseFilter:!1,collapseOptions:!0,collapseChart:!0,collapseTable:!1,exploreChart:!1,filterURL:null,filterForm:null,filterTab:null,autoSubmit:1E3,timeout:1E4,thousandSeparator:" ",thousandGrouping:"3",minTickSize:null,precision:null,textAll:"All",labelRecords:"Records"},_create:function(){this.id=u;u+=1;this.openRequest=
this.chart=this.table=null;this.eventNamespace=".pt"},_init:function(){var a=c(this.element),b=this.options;this.table=this.data=null;this.chartOptions={currentChart:null,currentDataIndex:null,currentSeriesIndex:null,currentSpectrumIndex:null};this.table_options={hidden:!1};var d=a.find(".pt-chart");this.chart=d.length?d.first():null;b.renderFilter||b.renderOptions?(d="#"+a.attr("id"),b.renderOptions?(c(d+"-options").show(),b.collapseOptions&&(c(d+"-options legend").siblings().toggle(),c(d+"-options legend").children().toggle())):
c(d+"-options").hide(),b.renderFilter?(c(d+"-filters").show(),b.collapseFilter&&(c(d+"-filters legend").siblings().toggle(),c(d+"-filters legend").children().toggle())):c(d+"-options").hide()):a.find(".pt-form-container").hide();b.collapseTable&&(this.table_options.hidden=!0,a.find(".pt-table").hide(),a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide());b.numberFormatter=function(e){var f=b.precision;if(null===e||"undefined"==typeof e)return"-";f=f||0==f?e.toFixed(f):e.toString();f=f.split(".");
e=f[0];f=1<f.length?"."+f[1]:"";e=e.replace(new RegExp("\\B(?=(\\d{"+b.thousandGrouping+"})+(?!\\d))","g"),b.thousandSeparator);return e+f};this.refresh()},_destroy:function(){this.table&&this.table.remove();this.chart&&this.chart.empty()},refresh:function(){var a=c(this.element),b=null;this._unbindEvents();var d=a.find('input[type="hidden"][name="pivotdata"]');d.length&&(b=JSON.parse(c(d).first().val()));b?"count"==b.method&&(this.options.precision=0,this.options.minTickSize=1):(b={empty:!0},a.find(".pt-hide-table").hide(),
a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide());this.data=b;this.lookups={};b.nodata?(a.find(".pt-table").first().empty().append(c('<div class="pt-no-data">'+b.nodata+"</div>")),a.find(".pt-hide-table").hide(),a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide()):(this._renderTable(),this._renderChartOptions());this._renderChart();b.empty?a.find(".pt-empty").show():a.find(".pt-empty").hide();this.options.autoSubmit?a.find(".pt-submit").hide():a.find(".pt-submit").show();
this._bindEvents();a.find(".pt-throbber").hide()},_renderTable:function(){var a=c(this.element),b=a.find(".pt-table").first().empty();this.table=null;var d=this.data;if(!d.empty)if(this.options.renderTable){var e=d.cells.slice(0),f=d.cols,g=d.rows,l=d.total,h=d.labels,k=!1,m=!1;d=d.facts;1==d.length&&"list"!=d[0][1]&&(1==g.length&&null===g[0][4]&&(k=!0),1==f.length&&null===f[0][4]&&(m=!0));d=this.options;var q=d.showTotals,v;if(m&&q)for(f=[],v=0;v<g.length;v++)e[v]=[];else{var y=function(p,A){return"__other__"!=
f[A][0]};for(v=0;v<g.length;v++)e[v]=e[v].filter(y);f=f.filter(function(p){return"__other__"!=p[0]})}k&&q?(g=[],e=[]):(e=e.filter(function(p,A){return"__other__"!=g[A][0]}),g=g.filter(function(p){return"__other__"!=p[0]}));b=d3.select(b.get(0)).append("table").attr("class","dataTable display report");b.append("thead").call(this._renderHeader,f,h,d).call(this._renderColumns,f,h,m);k&&q||b.append("tbody").call(this._renderRows,this,g,f,h,e,d);q&&b.append("tfoot").call(this._renderFooter,g,f,h,l);this.table=
c(b.node());this.table_options.hidden?(a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()):(a.find(".pt-show-table").hide(),a.find(".pt-hide-table").show(),a.find(".pt-export-opt").show())}else a.find(".pt-show-table").hide(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()},_renderHeader:function(a,b,d,e){a=a.append("tr");a.append("th").attr("scope","col").text(d.layer);b.length&&a.append("th").attr({scope:"col",colspan:b.length}).text(d.cols);
e.showTotals&&a.append("th").attr({scope:"col","class":"pt-totals-header pt-row-total",rowspan:2}).text(d.total);return a},_renderColumns:function(a,b,d,e){a=a.append("tr");a.append("th").attr({scope:"col","class":"pt-rows-header"}).text(d.rows);a.selectAll("th.pt-data").data(b).enter().append("th").attr({scope:"col","class":"pt-col-label"}).text(function(f){return e?"":f[4]});return a},_renderRows:function(a,b,d,e,f,g,l){d=a.selectAll("tr.pt-row").data(d).enter().append("tr").attr("class",function(h,
k){return k%2?"odd":"even"});d.append("td").text(function(h){return h[4]});d.selectAll("td.pt-cell").data(function(h,k){return g[k]}).enter().append("td").attr("class","pt-cell").each(b._renderCell,f);l.showTotals&&d.append("td").attr("class","pt-row-total").text(function(h){return h[2][0]});return d},_renderCell:function(a,b,d){b=d3.select(this);for(var e=a.i,f,g=0,l=e.length;g<l;g++){f=e[g];var h=b.append("div").attr("class","pt-cell-value");null===f?h.text(d.none):c.isArray(f)?h.append("ul").selectAll("li").data(f).enter().append("li").html(function(k){return k}):
h.text(f);1<l-g&&h.append("span").text(" / ")}(a=a.k)&&a.length&&(c(b.node()).data("recordIDs",a),b.append("div").attr("class","pt-cell-zoom"))},_renderCellRecords:function(a,b){var d=c(".pt-cell-zoom",a).removeClass("opened");a=c(".pt-cell-records",a).remove();if(b){var e=this.lookups,f=[],g,l=[];b.forEach(function(k){if(g=e[k]){if(g.constructor===Array){k=g[1];if(-1!=l.indexOf(k))return;l.push(k);g=g[0]}g&&f.push(g)}});a=c('<div class="pt-cell-records">');var h=c("<ul>").appendTo(a);f.length?(f.sort(function(k,
m){return k.localeCompare(m)}),f.forEach(function(k){c("<li>").html(k).appendTo(h)})):c("<li>").text(b.length+" "+this.options.textRecords).appendTo(h);d.addClass("opened").after(a)}},_renderFooter:function(a,b,d,e,f){b=b.length%2?"odd":"even";a=a.append("tr").attr("class",b+" pt-totals-row");a.append("th").attr({"class":"pt-totals-header",scope:"row"}).text(e.total);a.selectAll("td.pt-col-total").data(d).enter().append("td").attr("class","pt-col-total").text(function(g){return g[2][0]});a.append("td").attr("class",
"pt-total").text(f);return a},_renderChartOptions:function(){var a=c(this.element),b=a.find(".pt-chart-controls").first().empty(),d=this.data;if(!d.empty&&this.options.renderChart){d=d.labels;var e=a.attr("id");a=d.layer;var f=d.rows,g=d.cols,l=d.per,h=c('<div class="pt-chart-opts">'),k=e+"-pchart-rows",m=e+"-vchart-rows",q=e+"-hchart-rows",v=e+"-schart-rows",y=e+"-pchart-cols",p=e+"-vchart-cols",A=e+"-hchart-cols";e+="-schart-cols";a&&c(h).append(c('<span class="pt-chart-label">'+a+": </span>"));
f&&c(h).append(c('<div id="'+k+'" class="pt-chart-icon pt-pchart"/><div id="'+m+'" class="pt-chart-icon pt-vchart"/><span class="pt-chart-label">'+l+" "+f+"</span>"));g&&c(h).append(c('<div id="'+y+'" class="pt-chart-icon pt-pchart"/><div id="'+p+'" class="pt-chart-icon pt-vchart"/><span class="pt-chart-label">'+l+" "+g+"</span>"));f&&g&&c(h).append(c('<span class="pt-chart-label">| '+d.breakdown+': </span><div id="'+v+'" class="pt-chart-icon pt-schart"/><div id="'+q+'" class="pt-chart-icon pt-hchart"/><span class="pt-chart-label">'+
l+" "+f+'</span><div id="'+e+'"  class="pt-chart-icon pt-schart"/><div id="'+A+'"  class="pt-chart-icon pt-hchart"/><span class="pt-chart-label">'+l+" "+g+"</span>"));c(b).append(h)}},_truncateLabel:function(a,b){return a&&a.length>b?a.substring(0,b-3).replace(/\s+$/g,"")+"...":a},_renderChart:function(a){var b=c(this.element),d=this.data;c(".pt-chart-contents",b).hide();if(b=this.chart)if(c(b).off("plothover").off("plotclick").empty(),!d.empty&&this.options.renderChart)if(!1===a)this.options.collapseChart=
!0;else{b=this.options.collapseChart;if("undefined"==typeof a||!a){if(b)return;a=this.chartOptions.currentChart}if("undefined"==typeof a||!a){if(b)return;a=this.options.defaultChart}if("undefined"!=typeof a&&a){this.options.collapseChart=!1;this.chartOptions.currentChart=a;b=a.type;a=a.axis;var e=d.labels,f=e.per,g=e.layer+" "+f+" "+e.rows;e=e.layer+" "+f+" "+e.cols;f=d.filter;var l=f[0],h=f[1];"piechart"==b?"rows"==a?this._renderPieChart(d.rows,g,l):this._renderPieChart(d.cols,e,h):"barchart"==b?
"rows"==a?this._renderBarChart(d.rows,d.facts,g,l):this._renderBarChart(d.cols,d.facts,e,h):"breakdown"==b?"rows"==a?this._renderBreakDown(d,0,g,f):this._renderBreakDown(d,1,e,f):"spectrum"==b&&this._renderSpectrum(d,a,f)}}},_renderPieChart:function(a,b,d){var e=this.chart;if(e){c(e).css({height:"360px"}).closest(".pt-chart-contents").show().css({width:"98%"});b?c(e).siblings(".pt-chart-title").html("<h4>"+b+"</h4>"):c(e).siblings(".pt-chart-title").empty();var f=[],g=0;for(b=0;b<a.length;b++){var l=
a[b];!l[1]&&0<=l[2][0]&&(f.push({index:l[0],label:l[4],value:l[2][0],key:l[3]}),g+=l[2][0])}var h=this;h.chartOptions.currentDataIndex=null;var k=function(m){var q=m.index;if(h.chartOptions.currentDataIndex!=q){h._removeChartTooltip();h.chartOptions.currentDataIndex=q;m=m.data;var v=m.value,y=d3.event;h._renderChartTooltip(y.pageX,y.pageY,'<div class="pt-tooltip-label">'+m.label+'</div><div class="pt-tooltip-text">'+(v+" ("+Math.round(v/g*100)+"%)</div>"));c(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},
q)})}};nv.addGraph(function(){var m=nv.models.pieChart().x(function(q){return q.label}).y(function(q){return q.value}).labelsOutside(!1).labelType("percent").labelThreshold(.03).showLegend(!0);m.tooltip.enabled(!1);m.legend.align(!0).rightAlign(!1);m.pie.dispatch.on("elementMouseover",k).on("elementMouseout",function(){c(".pt-tooltip").remove();h.chartOptions.currentDataIndex=null;h.chartOptions.currentSeriesIndex=null});if(h.options.exploreChart&&d)m.pie.dispatch.on("elementClick",function(q){q=
q.data;h._chartExplore([["__other__"==q.index?d+"__belongs":d,q.key]])});d3.select(c(e).get(0)).append("svg").attr("class","nv").datum(f).transition().duration(1200).call(m);nv.utils.windowResize(m.update);return m})}},_renderBarChart:function(a,b,d,e){var f=this.chart;if(f){c(f).closest(".pt-chart-contents").show().css({width:"96%"});for(var g=[],l=this._truncateLabel,h,k,m,q=0;q<b.length;q++){h={key:b[q][2]};k=[];for(var v=0;v<a.length;v++)m=a[v],k.push({label:m[4],value:m[2][q],filterIndex:m[0],
filterKey:m[3]});h.values=k;g.push(h)}if(1==g.length&&18<a.length){var y=90;var p=!1;a="420px";var A={top:15,right:10,bottom:110,left:60}}else y=0,p=!0,a="360px",A={top:15,right:10,bottom:50,left:60};c(f).css({height:a});d?c(f).siblings(".pt-chart-title").html("<h4>"+d+"</h4>"):c(f).siblings(".pt-chart-title").empty();var F=function(x){x=x.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},x.index)+'">'+x.label+'</div><div class="pt-tooltip-text">'+
x.value+"</div></div>"},G=this,B=this.options.numberFormatter;nv.addGraph(function(){if(1<g.length){var x=nv.models.multiBarChart().x(function(r){return r.label}).y(function(r){return r.value}).staggerLabels(!0).showControls(!1);var z=x.multibar}else x=nv.models.discreteBarChart().x(function(r){return r.label}).y(function(r){return r.value}).margin(A).staggerLabels(p).showValues(!0).rotateLabels(y),x.valueFormat(B),z=x.discretebar;x.tooltip.contentGenerator(F);x.yAxis.tickFormat(B);x.xAxis.tickFormat(function(r){return l(r,
18)});d3.select(c(f).get(0)).append("svg").attr("class","nv").datum(g).transition().duration(500).call(x);if(G.options.exploreChart&&e)z.dispatch.on("elementClick",function(r){var H=r.data.filterKey;null===H&&(H="None");var D=e;"__other__"==r.data.filterIndex&&(D+="__belongs");G._chartExplore([[D,H]])});nv.utils.windowResize(x.update);return x})}},_renderBreakDown:function(a,b,d,e){var f=this.chart;if(f){c(f).closest(".pt-chart-contents").show().css({width:"96%"});var g=a.cells,l=[],h=[];if(0===b){var k=
a.rows;var m=a.cols;a=function(z,r){return g[l[z]][h[r]].v[0]};var q=e[0];var v=e[1]}else k=a.cols,m=a.rows,a=function(z,r){return g[h[r]][l[z]].v[0]},q=e[1],v=e[0];var y;e=[];b=[];var p=0;for(y=k.length;p<y;p++)k[p][1]||(e.push(k[p]),l.push(p));p=0;for(y=m.length;p<y;p++)m[p][1]||(b.push(m[p]),h.push(p));var A=[];for(k=0;k<b.length;k++){m={key:b[k][4],filterIndex:b[k][0],filterKey:b[k][3]};p=[];for(y=0;y<e.length;y++)p.push({label:e[y][4],filterIndex:e[y][0],filterKey:e[y][3],value:a(y,k)});m.values=
p;A.push(m)}a=Math.max(e.length*Math.max(16*(b.length+1),50)+70,360);c(f).css({height:a+"px"});d?c(f).siblings(".pt-chart-title").html("<h4>"+d+"</h4>"):c(f).siblings(".pt-chart-title").empty();var F=function(z){var r=z.series[0];z=z.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},z.index)+'">'+r.key+'</div><div class="pt-tooltip-text">'+z.label+': <span class="pt-tooltip-value">'+z.value+"</span></div></div>"},G=this,B=this.options.numberFormatter,
x=this._truncateLabel;nv.addGraph(function(){var z=nv.models.multiBarHorizontalChart().x(function(r){return r.label}).y(function(r){return r.value}).margin({top:20,right:20,bottom:20,left:175}).showValues(!0).duration(350).showControls(!0);z.tooltip.contentGenerator(F);z.valueFormat(B);z.yAxis.tickFormat(B);z.xAxis.tickFormat(function(r){return x(r,24)});d3.select(c(f).get(0)).append("svg").attr("class","nv").datum(A).call(z);if(G.options.exploreChart&&q&&v)z.multibar.dispatch.on("elementClick",function(r){r=
r.data;var H=d3.event.currentTarget.parentElement.__data__,D=H.filterKey;null===D&&(D="None");H="__other__"==H.filterIndex?v+"__belongs":v;var K=r.filterKey;null===K&&(K="None");G._chartExplore([["__other__"==r.filterIndex?q+"__belongs":q,K],[H,D]])});nv.utils.windowResize(z.update);return z})}},_renderSpectrum:function(a,b,d){var e=this.chart;if(e){var f=this,g=a.cells,l=a.labels;if("rows"==b){var h=a.rows;var k=a.cols;b=l.rows;var m=l.cols;var q=d[0];var v=d[1];var y=function(n,w){return g[n][w]}}else h=
a.cols,k=a.rows,b=l.cols,m=l.rows,q=d[1],v=d[0],y=function(n,w){return g[w][n]};var p=function(n,w){return null===n?k[w]:null===w?h[n]:y(n,w)},A=function(n,w){w===t&&(w="silver");for(var E=[],C,I,J=0;J<k.length;J++)C=p(null,J),I=null===n?C[2][0]:p(n,J).v[0],!C[1]&&0<=C[2][0]&&E.push({filterIndex:C[0],filterKey:C[3],label:C[4],value:I,color:w});return E},F=[],G=0;for(d=0;d<h.length;d++){var B=p(d,null);!B[1]&&0<=B[2][0]&&(F.push({position:d,filterIndex:B[0],filterKey:B[3],label:B[4],value:B[2][0]}),
G+=B[2][0])}f.chartOptions.currentDataIndex=null;c(e).removeAttr("style").closest(".pt-chart-contents").css({width:"98%",height:"auto"}).show();c(e).siblings(".pt-chart-title").empty();d=c('<div class="pt-spectrum-pie">').appendTo(e);e=c('<div class="pt-spectrum-bar">').appendTo(e);var x=this.options.numberFormatter,z=this._truncateLabel,r=nv.models.discreteBarChart().x(function(n){return n.label}).y(function(n){return n.value}).color(["silver"]).staggerLabels(!0).showValues(!0);r.tooltip.contentGenerator(function(n){n=
n.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+(n.color||["silver"])+'">'+n.label+'</div><div class="pt-tooltip-text">'+x(n.value)+"</div></div>"});r.valueFormat(x);r.yAxis.tickFormat(x);r.xAxis.tickFormat(function(n){return z(n,18)});var H=d3.select(c(e).get(0)).append("svg").attr("class","nv");e=Math.floor(d.width()/2)-30;var D=nv.models.pieChart().x(function(n){return n.label}).y(function(n){return n.value}).height(280).width(e).margin({top:-20,left:20}).labelType("percent").labelThreshold(.1).showLegend(!1).donut(!0).donutRatio(.35);
D.tooltip.enabled(!1);D.legend.align(!0).rightAlign(!1);D.pie.startAngle(function(n){return n.startAngle/2-Math.PI/2}).endAngle(function(n){return n.endAngle/2-Math.PI/2});D.pie.dispatch.on("elementMouseover",function(n){var w=n.index;if(f.chartOptions.currentDataIndex!=w){f._removeChartTooltip();f.chartOptions.currentDataIndex=w;n=n.data;var E=n.value,C=d3.event;f._renderChartTooltip(C.pageX,C.pageY,'<div class="pt-tooltip-label">'+n.label+'</div><div class="pt-tooltip-text">'+(E+" ("+Math.round(E/
G*100)+"%)</div>"));c(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},w)})}}).on("elementMouseout",function(){c(".pt-tooltip").remove();f.chartOptions.currentDataIndex=null;f.chartOptions.currentSeriesIndex=null});var K=d3.select(c(d).get(0)).append("svg").attr("class","nv").style({"min-width":e-30+"px"});e=d3.select(c(d).get(0)).append("div").attr("class","pt-spectrum-form");e.append("h4").html(l.layer+" "+l.per+" "+m);e.append("label").html(b+":");var L=e.append("select");L.append("option").attr("value",
"null").style("font-weight","bold").html(f.options.textAll);L.selectAll(".pt-series-item").data(F).enter().append("option").attr("class","pt-series-item").attr("value",function(n,w){return w}).html(function(n){return n.label});e.append("label").html(l.total+":");var N=e.append("span").text(a.total),M=function(n){if(null===n||f.chartOptions.currentSpectrumIndex==n){var w=function(I,J){return nv.utils.defaultColor()({},J)};K.selectAll(".nv-slice").style("fill",w).style("stroke",w);w=A(null);H.datum([{key:null,
filterIndex:null,filterKey:null,values:w}]);r.update();f.chartOptions.currentSpectrumIndex=null;L.property("value","null");N.text(a.total)}else{var E=F[n],C=nv.utils.defaultColor()({},n);w=function(I,J){return J==n?C:"silver"};K.selectAll(".nv-slice").style("fill",w).style("stroke",w);w=A(E.position,C);H.datum([{key:E.position,filterIndex:E.filterIndex,filterKey:E.filterKey,values:w}]);r.update();f.chartOptions.currentSpectrumIndex=n;L.property("value",n);N.text(F[n].value)}};D.pie.dispatch.on("elementClick",
function(n){M(n.index)});L.on("change.pt",function(){var n=d3.select(this).property("value");"null"==n?M(null):M(n)});nv.addGraph(function(){K.datum(F).transition().duration(1200).call(D);nv.utils.windowResize(D.update);return D});nv.addGraph(function(){H.datum([{key:null,filterIndex:null,filterKey:null,values:A(null)}]).transition().duration(500).call(r);if(f.options.exploreChart&&q&&v)r.discretebar.dispatch.on("elementClick",function(n){var w=n.data,E=d3.event.currentTarget.parentElement.__data__;
n=E.filterIndex;E=E.filterKey;var C=w.filterIndex;w=w.filterKey;var I=[];null!==n&&I.push(["__other__"==n?q+"__belongs":q,E||"None"]);null!==C&&I.push(["__other__"==C?v+"__belongs":v,w||"None"]);f._chartExplore(I)});nv.utils.windowResize(r.update);return r})}},_chartExplore:function(a){var b=this.options,d=c(this.element).closest(".ui-tabs"),e=b.filterTab;if(d.length&&!1!==e)b=(b=b.filterForm)?c("#"+b):t,S3.search.setCurrentFilters(b,a),a=e?c("#"+e).index():0,d.tabs("option","active",a);else if(d=
b.filterURL)a=this._updateURL(d,a),window.open(a,"_blank")},_cellExplore:function(a){if(c(".pt-cell-records",a).length)this._renderCellRecords(a,!1);else{var b=a.data("recordIDs");if(b.length){var d=c.Deferred(),e=this;d.promise().then(function(){e._renderCellRecords(a,b)});var f=this._updateAjaxURL({explore:"1"},null,!0),g=this.lookups,l=b.filter(function(m){return!g.hasOwnProperty(m)});if(l.length){var h=c(".pt-cell-zoom",a).hide(),k=c('<div class="inline-throbber">');k.css({display:"inline-block"}).insertAfter(h);
c.ajaxS3({type:"POST",url:f,data:JSON.stringify(l),dataType:"json",contentType:"application/json; charset=utf-8",success:function(m){c.extend(e.lookups,m);d.resolve();k.remove();h.show()},error:function(){d.reject();k.remove();h.show()}})}else d.resolve()}}},_renderChartTooltip:function(a,b,d){c('<div class="pt-tooltip">'+d+"</div>").css({position:"absolute",display:"none",top:b-50,left:a+10,border:"1px solid #999",padding:"10px","min-height":"50px","max-width":"240px","z-index":"501","background-color":"white",
color:"#000",opacity:.95}).appendTo("body").fadeIn(200)},_removeChartTooltip:function(){c(".pt-tooltip").remove();this.chartOptions.currentDataIndex=null;this.chartOptions.currentSeriesIndex=null},_getOptions:function(){var a="#"+c(this.element).attr("id");return{rows:c(a+"-rows").val(),cols:c(a+"-cols").val(),fact:c(a+"-fact").val(),totals:c(a+"-totals").is(":checked")?1:0}},_getFilters:function(){var a="#"+c(this.element).attr("id"),b=null;a=c(a+"-filters");if(a.length)try{b=S3.search.getCurrentFilters(a.first())}catch(d){}return b},
_updateURL:function(a,b){var d=[],e={},f;if(b){var g=0;for(f=b.length;g<f;g++){var l=b[g];var h=l[0];e[h]=!0;d.push(h+"="+l[1])}}b=this.options.ajaxURL.split("?");if(1<b.length){l=b[1].split("&");b={};g=0;for(f=l.length;g<f;g++){var k=l[g].split("=");1<k.length&&(h=decodeURIComponent(k[0]),e[h]||(d.push(h+"="+decodeURIComponent(k[1])),b[h]=!0))}for(h in b)e[h]=!0}b=a.split("?");if(1<b.length)for(l=b[1].split("&"),g=0,f=l.length;g<f;g++)k=l[g].split("="),1<k.length&&(h=decodeURIComponent(k[0]),e[h]||
d.push(h+"="+decodeURIComponent(k[1])));a=d.join("&");d=b[0];a&&(d=d+"?"+a);return d},_updateAjaxURL:function(a,b,d){var e=this.options.ajaxURL.split("?"),f=[],g=!1;if(1<e.length){var l=e[1];l=l.split("&")}else l="",l=[];if(a)for(m in a){var h=a[m];var k=m+"="+h;"totals"==m?this.options.showTotals=h?!0:!1:g||-1!=c.inArray(k,l)||(g=!0);f.push(k)}var m={};var q={},v;if(b){var y=function(A){var F,G,B=[];["contains","anyof","belongs","eq"].forEach(function(x){F=new RegExp("__"+x+"$","g");A.match(F)?G=
F:B.push(x)});G&&B.forEach(function(x){q[A.replace(G,"__"+x)]=!0})};h=0;for(v=b.length;h<v;h++){k=b[h];var p=k[0];k=k[1];y(p);null===k?m[p]||(q[p]=!0):(q[p]&&(q[p]=!1),k=p+"="+encodeURIComponent(k),m[p]?m[p].push(k):m[p]=[k])}}h=0;for(v=l.length;h<v;h++)k=l[h].split("="),1<k.length&&(p=decodeURIComponent(k[0]),k=decodeURIComponent(k[1]),q[p]?g=!0:m[p]?g||-1!=c.inArray(p+"="+k,m[p])||(g=!0):"aggregate"!=p&&(a&&a.hasOwnProperty(p)||f.push(l[h])));for(p in m)for(h=0,v=m[p].length;h<v;h++)g||-1!=c.inArray(m[p][h],
l)||(g=!0),f.push(m[p][h]);a=f.join("&");e=e[0];a&&(e=e+"?"+a);if(d)return e;this.options.ajaxURL=e;return g},_setExtension:function(a,b){var d=document.createElement("a");d.href=a;a=d.pathname.split("/");var e=[];a.length&&(a.forEach(function(g){var l=g.lastIndexOf(".");-1!=l?e.push(g.slice(0,l)):e.push(g)}),e[e.length-1]+="."+b,d.pathname=e.join("/"));var f=d.search;f&&(e=f.slice(1).split().filter(function(g){return"format"!=g.split("=")[0]}),a.length||e.push("format="+b),d.search="?"+e.join("&"));
return d.href},reload:function(a,b,d){d="undefined"!=typeof d?d:!0;"undefined"==typeof b&&(b=this._getFilters());var e=this,f=this.element,g=f.find('input[type="hidden"][name="pivotdata"]');if(g.length){f.find(".pt-throbber").show();if(a||b)var l=this._updateAjaxURL(a,b);l||d?(a=this.options.ajaxURL,b=this.options.timeout,d=c.ajaxS3,c.searchS3!==t&&(d=c.searchS3),f.find(".pt-empty").hide(),e.openRequest&&(e.openRequest.onreadystatechange=null,e.openRequest.abort()),e.openRequest=d({timeout:b,url:a,
dataType:"json",type:"GET",success:function(h){e.openRequest=null;g.first().val(JSON.stringify(h));e.refresh()},error:function(h,k,m){console.log("UNAUTHORIZED"==m?i18n.gis_requires_login:h.responseText)}})):e.refresh()}},_downloadXLS:function(){if(this.element.find('input[type="hidden"][name="pivotdata"]').length){var a=this._getOptions(),b=this._getFilters();a=this._updateAjaxURL(a,b,!0);a=this._setExtension(a,"xls");c.searchDownloadS3!==t?c.searchDownloadS3(a,"_blank"):window.open(a)}},_bindEvents:function(){var a=
this,b=c(this.element),d=this.eventNamespace,e="#"+b.attr("id");c(e+"-options legend").on("click"+d,function(){c(this).siblings().toggle();c(this).children().toggle()});c(e+"-filters legend").on("click"+d,function(){c(this).siblings().toggle();c(this).children().toggle()});c(".pt-hide-table",b).on("click"+d,function(){a.table_options.hidden=!0;c(".pt-table",b).hide();c(".pt-export-opt",b).hide();c(this).hide().siblings(".pt-show-table").show()});c(".pt-show-table",b).on("click"+d,function(){a.table_options.hidden=
!1;c(".pt-table",b).show();c(".pt-export-opt",b).show();c(this).hide().siblings(".pt-hide-table").show()});c(".pt-export-xls",b).on("click"+d,function(){a._downloadXLS()});c(e+"-totals").on("click"+d,function(){var g=c(this).is(":checked");a.options.showTotals!=g&&a.reload({totals:g},null,!1)});c(e+"-rows,"+e+"-cols,"+e+"-fact").on("change.autosubmit",function(){c(e+"-pt-form").trigger("optionChanged")});if(this.options.autoSubmit){var f=this.options.autoSubmit;c(e+"-pt-form").on("optionChanged",
function(){var g=c(this);if(!g.data("noAutoSubmit")){var l=g.data("autoSubmitTimeout");l&&clearTimeout(l);l=setTimeout(function(){var h=a._getOptions(),k=a._getFilters();a.reload(h,k,!1)},f);g.data("autoSubmitTimeout",l)}})}else c(e+"-pt-form input.pt-submit").on("click"+d,function(){var g=a._getOptions(),l=a._getFilters();a.reload(g,l,!1)});c(e+" .pt-table .pt-cell-zoom").on("click"+d,function(g){g=c(g.currentTarget).closest(".pt-cell");g.length&&a._cellExplore(g)});c(e+"-pchart-rows").on("click"+
d,function(){a._renderChart({type:"piechart",axis:"rows"})});c(e+"-vchart-rows").on("click"+d,function(){a._renderChart({type:"barchart",axis:"rows"})});c(e+"-schart-rows").on("click"+d,function(){a._renderChart({type:"spectrum",axis:"rows"})});c(e+"-hchart-rows").on("click"+d,function(){a._renderChart({type:"breakdown",axis:"rows"})});c(e+"-pchart-cols").on("click"+d,function(){a._renderChart({type:"piechart",axis:"cols"})});c(e+"-vchart-cols").on("click"+d,function(){a._renderChart({type:"barchart",
axis:"cols"})});c(e+"-schart-cols").on("click"+d,function(){a._renderChart({type:"spectrum",axis:"cols"})});c(e+"-hchart-cols").on("click"+d,function(){a._renderChart({type:"breakdown",axis:"cols"})});c(".pt-hide-chart",b).on("click"+d,function(){a._renderChart(!1)})},_unbindEvents:function(){var a=c(this.element),b="#"+a.attr("id"),d=this.eventNamespace;c(b+" .pt-table .pt-cell-zoom").off(d);c(b+"-options legend").off(d);c(b+"-filters legend").off(d);c(b+"-totals").off(d);c(b+"-rows,"+b+"-cols,"+
b+"-fact").off("change.autosubmit");c(b+"-pt-form").off("optionChanged");c("input.pt-submit, .pt-export-xls",a).off(d);c(b+"-pchart-rows,"+b+"-vchart-rows,"+b+"-schart-rows,"+b+"-hchart-rows,"+b+"-pchart-cols,"+b+"-vchart-cols,"+b+"-schart-cols,"+b+"-hchart-cols").off(d);c(".pt-hide-table, .pt-show-table, .pt-hide-chart",a).off(d)}})})(jQuery);
