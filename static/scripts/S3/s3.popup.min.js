function s3_popup_refresh_caller(a){var b=getQueryParams(document.location.search),c=window.parent,p,l,g,f=b.refresh;if(void 0!==f){isNaN(parseInt(f))||c.location.reload(!0);var d=c.$("#"+f);if(d.hasClass("dl")){var h=b.record;void 0!==h?d.datalist("ajaxReloadItem",h):d.datalist("ajaxReload")}else if(d.hasClass("s3-organizer"))try{d.organizer("reload")}catch(e){}else if(d.children("div").hasClass("s3-hierarchy-tree"))try{d.hierarchicalcrud("reload")}catch(e){}else try{d.dataTable().fnReloadAjax()}catch(e){}var v=
c.S3.gis.maps;if("undefined"!=typeof v)for(g in v){var m=v[g];h=f.replace(/-/g,"_");a=m.layers;b=0;for(l=a.length;b<l;b++){var k=a[b];if(k.s3_layer_id==h){var A=k.strategies;k=0;for(p=A.length;k<p;k++){var B=A[k];if("OpenLayers.Strategy.Refresh"==B.CLASS_NAME){B.refresh();break}}break}}}c.$(".filter-form").trigger("dataChanged",f);c.S3.popup_remove()}else if(h=b.refresh_layer,"undefined"!=typeof h){if(v=c.S3.gis.maps,"undefined"!=typeof v)for(g in"undefined"!=h&&(h=parseInt(h)),f=c.i18n.gis_draft_layer,
v)for(m=v[g],a=m.layers,b=0,l=a.length;b<l;b++)if(k=a[b],k.s3_layer_id==h)for(A=k.strategies,k=0,p=A.length;k<p;k++){if(B=A[k],"OpenLayers.Strategy.Refresh"==B.CLASS_NAME){B.refresh();break}}else if(k.name==f){for(;m.popups.length;)m.removePopup(m.popups[0]);p=k.features;for(k=p.length-1;0<=k;k--)p[k].destroy()}}else if(g=b.node)h=c.$("#"+b.hierarchy),g=c.$("#"+g),h&&g&&h.hierarchicalcrud("refreshNode",g),c.S3.popup_remove();else if(g=b.agent,"undefined"!=typeof g)h="undefined"!=typeof a?[a]:[],c.$("#"+
g).trigger("configSaved",h);else if("undefined"!=typeof b.level)c.S3.popup_remove();else{var n=b.caller;if(void 0===n)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),c.S3.popup_remove();else if(s3_debug("Caller",n),g=b.person_id,"undefined"!=typeof g)c.$("#"+n).val(g).change(),c.S3.popup_remove();else{a=b.child;f=b.prefix;g=b.optionsVar;h=b.optionsValue;var C=b.parent;l=""+c.location;m=new RegExp(".*\\"+S3.Ap+"\\/");if("undefined"===typeof a){a=(""+window.location).replace(m,
"");a=a.split("?")[0].split("/");var x=a[1].split(".")[0]+"_id"}else x=a;s3_debug("childResource",x);a=l.replace(m,"");"undefined"===typeof C?(b=n.replace("_"+x,""),s3_debug("parentField",b),l=b.replace(/_.*/,""),b=b.replace(l+"_",""),a=a.split("?")[0].split("/"),l=null,f||(f=a[0]),m=a[1],2<a.length&&(null!==a[2].match(/\d*/)?3<a.length&&(l=a[3]):l=a[2]),null!==l&&b!=m&&b==l&&(b=m+"/"+l)):(b=C,f||(a=l.replace(m,""),a=a.split("?")[0].split("/"),f=a[0]));s3_debug("parentResource",b);s3_debug("lookupPrefix",
f);s3_debug("optionsVar",g);s3_debug("optionsValue",h);f=S3.Ap.concat("/"+f+"/"+b+"/options.s3json?field="+x);"undefined"!==typeof g&&"undefined"!==typeof h&&(f+="&"+g+"="+h);d=c.$("#"+n);s3_debug("callerWidget",d);var K="sub_"==n.substring(0,4),G=c.$("#dummy_"+n),H=void 0!==G.val();s3_debug("hasDummy",H);var E=d.hasClass("checkboxes-widget-s3"),I=d.hasClass("s3-hierarchy-input"),F;if(E){var L=c.$("#"+n+" tbody tr:first").children().length;var q=[]}else{var M=c.$("#"+n+" >option");(F="select"==d.prop("tagName").toLowerCase())?
q=[]:f=I?f+"&hierarchy=1&only_last=1":f+"&only_last=1"}var y=1,J="";$.getJSONS3(f,function(e){var t=0;if((e=e.option)&&e.length)if(e.forEach(function(w){var u=w["@value"],z=w.$;void 0===z&&(z="");F?q.push(["<option value='",u,"'>",z,"</option>"].join("")):E?(w="id_"+x+"-"+t,q.push(["<td><input id='",w,"' name='",x,"' value='",u,"' type='checkbox'><label for='",w,"'>",z,"</label></td>"].join("")),t++):I&&(C=w["@parent"],d.parent().hierarchicalopts("addNode",C,u,z,!0));u=+u;!isNaN(u)&&u>y&&(y=u,J=z)}),
H&&(G.val(J),d.val(y).change()),F){if(K){var r=["_0","_none","_default"],N=n.split("_").slice(0,-1).join("_");for(e=0;e<r.length;e++){var O=r[e];c.$("#"+N+O).empty().append(q.join(""))}}else M.remove(),d.append(q.join("")).val(y).change();d.val(y).change();d.prop("disabled",!1);if(d.hasClass("multiselect-widget")&&d.multiselect("instance"))try{d.multiselect("refresh")}catch(w){}}else{if(E){var D=[];c.$("#"+n+" input").each(function(){$(this).prop("checked")&&D.push($(this).val())});r=[];for(e=t=0;e<
q.length;e++)0===t?(r.push("<tr>"),r.push(q[e]),t++):t==L-1?(r.push(q[e]),r.push("</tr>"),t=0):(r.push(q[e]),t++);d.html(r.join(""));D.push(y);for(e=0;e<D.length;e++)c.$("#"+n+' input[value="'+D[e]+'"]').prop("checked",!0)}}else s3_debug("No options available to refresh parent field");c.S3.popup_remove()})}}}function getQueryParams(a){a=a.substring(1);var b={};if(a){a=a.split("&");for(var c,p=0,l=a.length;p<l;p++)c=a[p].split("="),b[decodeURIComponent(c[0])]=decodeURIComponent(c[1])}return b};
