function s3_popup_refresh_caller(a){var b=getQueryParams(document.location.search),c=window.parent,q,m,f,l=b.refresh;if(void 0!==l){isNaN(parseInt(l))||c.location.reload(!0);var d=c.$("#"+l);if(d.hasClass("dl")){var g=b.record;void 0!==g?d.datalist("ajaxReloadItem",g):d.datalist("ajaxReload")}else if(d.hasClass("s3-organizer"))try{d.organizer("reload")}catch(e){}else if(d.children("div").hasClass("s3-hierarchy-tree"))try{d.hierarchicalcrud("reload")}catch(e){}else try{d.dataTable().fnReloadAjax()}catch(e){}var x=
c.S3.gis.maps;if("undefined"!=typeof x)for(f in x){var n=x[f];g=l.replace(/-/g,"_");a=n.layers;b=0;for(m=a.length;b<m;b++){var h=a[b];if(h.s3_layer_id==g){var B=h.strategies;h=0;for(q=B.length;h<q;h++){var C=B[h];if("OpenLayers.Strategy.Refresh"==C.CLASS_NAME){C.refresh();break}}break}}}c.$(".filter-form").trigger("dataChanged",l);c.S3.popup_remove()}else if(g=b.refresh_layer,"undefined"!=typeof g){if(x=c.S3.gis.maps,"undefined"!=typeof x)for(f in"undefined"!=g&&(g=parseInt(g)),l=c.i18n.gis_draft_layer,
x)for(n=x[f],a=n.layers,b=0,m=a.length;b<m;b++)if(h=a[b],h.s3_layer_id==g)for(B=h.strategies,h=0,q=B.length;h<q;h++){if(C=B[h],"OpenLayers.Strategy.Refresh"==C.CLASS_NAME){C.refresh();break}}else if(h.name==l){for(;n.popups.length;)n.removePopup(n.popups[0]);q=h.features;for(h=q.length-1;0<=h;h--)q[h].destroy()}}else if(f=b.node)g=c.$("#"+b.hierarchy),f=c.$("#"+f),g&&f&&g.hierarchicalcrud("refreshNode",f),c.S3.popup_remove();else if(f=b.agent,"undefined"!=typeof f)g="undefined"!=typeof a?[a]:[],c.$("#"+
f).trigger("configSaved",g);else if("undefined"!=typeof b.level)c.S3.popup_remove();else{var k=b.caller;if(void 0===k)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),c.S3.popup_remove();else if(s3_debug("caller",k),f=b.person_id,"undefined"!=typeof f)c.$("#"+k).val(f).trigger("change"),c.S3.popup_remove();else{a=b.child;l=b.prefix;f=b.optionsVar;g=b.optionsValue;var v=b.parent;m=""+c.location;n=new RegExp(".*\\"+S3.Ap+"\\/");if("undefined"===typeof a){a=(""+window.location).replace(n,
"");a=a.split("?")[0].split("/");var z=a[1].split(".")[0]+"_id"}else z=a;s3_debug("childResource",z);a=m.replace(n,"");"undefined"===typeof v?(b=k.replace("_"+z,""),s3_debug("parentField",b),m=b.replace(/_.*/,""),b=b.replace(m+"_",""),a=a.split("?")[0].split("/"),m=null,l||=a[0],n=a[1],2<a.length&&(null!==a[2].match(/\d*/)?3<a.length&&(m=a[3]):m=a[2]),null!==m&&b!=n&&b==m&&(b=n+"/"+m)):(b=v,l||(a=m.replace(n,""),a=a.split("?")[0].split("/"),l=a[0]));s3_debug("parentResource",b);s3_debug("lookupPrefix",
l);s3_debug("optionsVar",f);s3_debug("optionsValue",g);l=S3.Ap.concat("/"+l+"/"+b+"/options.s3json?field="+z);"undefined"!==typeof f&&"undefined"!==typeof g&&(l+="&"+f+"="+g);d=c.$("#"+k);var D=d.hasClass("checkboxes-widget-s3"),K="sub_"==k.substring(0,4),H=c.$("#dummy_"+k),I=void 0!==H.val(),E,G=d.hasClass("s3-hierarchy-input");s3_debug("hasDummy",I);if(D){s3_debug("checkboxes",D);var L=c.$("#"+k+" tbody tr:first").children().length;var t=[]}else{var M=c.$("#"+k+" >option");(E="select"==d.prop("tagName").toLowerCase())?
(s3_debug("isDropdown",E),t=[]):G?(s3_debug("isHierarchyWidget",G),l+="&hierarchy=1&only_last=1"):l+="&only_last=1"}var A=1,J="";$.getJSONS3(l,function(e){var w=0;if((e=e.option)&&e.length)if(e.forEach(function(y){var p=y["@value"],r=y.$;void 0===r&&(r="");E?t.push(["<option value='",p,"'>",r,"</option>"].join("")):D?(y="id_"+z+"-"+w,t.push(["<td><input id='",y,"' name='",z,"' value='",p,"' type='checkbox'><label for='",y,"'>",r,"</label></td>"].join("")),w++):G&&(v=y["@parent"],d.parent().hierarchicalopts("addNode",
v,p,r,!0),k.startsWith("sub_")&&(k.endsWith("_none")?(c.$("#"+k.replace("_none","_0")).parent().hierarchicalopts("addNode",v,p,r,!1),c.$("#"+k.replace("_none","_default")).parent().hierarchicalopts("addNode",v,p,r,!1)):k.endsWith("_0")&&(c.$("#"+k.replace("_0","_none")).parent().hierarchicalopts("addNode",v,p,r,!1),c.$("#"+k.replace("_0","_default")).parent().hierarchicalopts("addNode",v,p,r,!1))));p=+p;!isNaN(p)&&p>A&&(A=p,J=r)}),I&&(H.val(J),d.val(A).trigger("change")),E){if(K){var u=["_0","_none",
"_default"],N=k.split("_").slice(0,-1).join("_");for(e=0;e<u.length;e++){var O=u[e];c.$("#"+N+O).empty().append(t.join(""))}}else M.remove(),d.append(t.join("")).val(A).trigger("change");d.val(A).trigger("change");d.prop("disabled",!1);if(d.hasClass("multiselect-widget")&&d.multiselect("instance"))try{d.multiselect("refresh")}catch(y){}}else{if(D){var F=[];c.$("#"+k+" input").each(function(){$(this).prop("checked")&&F.push($(this).val())});u=[];for(e=w=0;e<t.length;e++)0===w?(u.push("<tr>"),u.push(t[e]),
w++):w==L-1?(u.push(t[e]),u.push("</tr>"),w=0):(u.push(t[e]),w++);d.html(u.join(""));F.push(A);for(e=0;e<F.length;e++)c.$("#"+k+' input[value="'+F[e]+'"]').prop("checked",!0)}}else s3_debug("No options available to refresh parent field");c.S3.popup_remove()})}}}function getQueryParams(a){a=a.substring(1);var b={};if(a){a=a.split("&");for(var c,q=0,m=a.length;q<m;q++)c=a[q].split("="),b[decodeURIComponent(c[0])]=decodeURIComponent(c[1])}return b};
